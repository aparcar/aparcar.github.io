<!doctype html><html lang=en-us>
<head>
<meta http-equiv=x-clacks-overhead content="GNU Terry Pratchett">
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0">
<title>LoRaWAN Evaluation | aparcar</title>
<meta name=title content="LoRaWAN Evaluation">
<meta name=description content="Introduction This project evaluates the LoRa frequency modulation and the LoRaWAN stack as an alternative for existing sensor setups using the technologies ZigBee and GSM. The current scope is to build a simple stack to collect sensor data and visualize them inside a web interface.
Within this work modular nodes were designed allowing to measure a variety of environmental metrics, including temperature, rain fall, humidity and sea level.
Software and hardware used on sensor nodes are documented to allow easy replication of the setup.">
<meta name=keywords content="lora,lorawan,iot,">
<meta property="og:title" content="LoRaWAN Evaluation">
<meta property="og:description" content="Introduction This project evaluates the LoRa frequency modulation and the LoRaWAN stack as an alternative for existing sensor setups using the technologies ZigBee and GSM. The current scope is to build a simple stack to collect sensor data and visualize them inside a web interface.
Within this work modular nodes were designed allowing to measure a variety of environmental metrics, including temperature, rain fall, humidity and sea level.
Software and hardware used on sensor nodes are documented to allow easy replication of the setup.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://aparcar.org/lorawan-evaluation/"><meta property="article:section" content="blog">
<meta property="article:published_time" content="2021-09-27T00:00:00+00:00">
<meta property="article:modified_time" content="2021-09-27T00:00:00+00:00"><meta property="og:site_name" content="aparcar">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="LoRaWAN Evaluation">
<meta name=twitter:description content="Introduction This project evaluates the LoRa frequency modulation and the LoRaWAN stack as an alternative for existing sensor setups using the technologies ZigBee and GSM. The current scope is to build a simple stack to collect sensor data and visualize them inside a web interface.
Within this work modular nodes were designed allowing to measure a variety of environmental metrics, including temperature, rain fall, humidity and sea level.
Software and hardware used on sensor nodes are documented to allow easy replication of the setup.">
<meta itemprop=name content="LoRaWAN Evaluation">
<meta itemprop=description content="Introduction This project evaluates the LoRa frequency modulation and the LoRaWAN stack as an alternative for existing sensor setups using the technologies ZigBee and GSM. The current scope is to build a simple stack to collect sensor data and visualize them inside a web interface.
Within this work modular nodes were designed allowing to measure a variety of environmental metrics, including temperature, rain fall, humidity and sea level.
Software and hardware used on sensor nodes are documented to allow easy replication of the setup."><meta itemprop=datePublished content="2021-09-27T00:00:00+00:00">
<meta itemprop=dateModified content="2021-09-27T00:00:00+00:00">
<meta itemprop=wordCount content="9270">
<meta itemprop=keywords content="lora,lorawan,iot,">
<meta name=referrer content="no-referrer-when-downgrade">
<style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#eee}pre code{border-left:1px solid #999;color:#555;display:block;padding:10px;white-space:pre-wrap}blockquote{border-left:1px solid #999;color:#555;padding-left:10px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}</style>
<link rel=stylesheet href=/style.css>
</head>
<body>
<header><a href=/ class=title>
<h2>aparcar</h2>
</a>
<nav><a href=/>Home</a>
<a href=/blog>Blog</a>
</nav>
</header>
<main>
<h1>LoRaWAN Evaluation</h1>
<p>
<i>
<time datetime=2021-09-27 pubdate>
27 Sep, 2021
</time>
</i>
</p>
<content>
<h1 id=introduction>Introduction</h1>
<p>This project evaluates the <em>LoRa</em> frequency modulation and the <em>LoRaWAN</em> stack
as an alternative for existing sensor setups using the technologies <em>ZigBee</em> and
<em>GSM</em>. The current scope is to build a simple stack to collect sensor data and
visualize them inside a web interface.</p>
<p>Within this work modular nodes were designed allowing to measure a variety of
environmental metrics, including temperature, rain fall, humidity and sea level.</p>
<p>Software and hardware used on sensor nodes are documented to allow easy
replication of the setup. Further multiple recommendations regarding software
libraries and hardware are given.</p>
<p>All work happened in collaboration with the <em>MESH LAB</em> at Oahu, Hawaii,
supervised by <a href=https://www.soest.hawaii.edu/oceanography/glazer/Brian_T._Glazer/CV.html>Dr. Brian
Glazer</a>
and <a href=http://www2.hawaii.edu/~esb/>Dr. Edo Biagioni</a>.</p>
<blockquote>
<p>Note: This manual is work in progress and may receive updates over time. A
list of changes will be attached to the bottom with corresponding dates.</p>
</blockquote>
<h2 id=motivation>Motivation</h2>
<p>Based on the architecture of LoRaWAN, described in the
<a href=#thethingsnetwork>TheThingsNetwork</a> section, it allows a separation of sensor
nodes and base stations. In simple terms this could be compared to a free
cellular network where every user brings their own phone while the cellular base
stations are managed by an organization with the public interest of
connectivity. With LoRaWAN it is possible for researchers to deploy their sensor
nodes while other entities, like universities or even states, handle the signal
coverage.</p>
<p>The existing setup aimed to upgrade and extend uses both cellular <em>GSM</em> and
<em>ZigBee</em>. While the formers base stations are managed by third parties it
involves a recurring fee of usage, making large scale deployments less feasible.
<em>ZigBee</em> requires researchers to manage their own gateways since there is no
roaming standard or protocol for multiple users to share a base station.</p>
<p>LoRaWAN solves this by introducing a software stack which allows multiple
entities to share base stations but also allows easy deployment of base stations
contributing to the network as a whole.</p>
<p>Within this project existing sensor setups were <em>rebuild</em> to use LoRaWAN
instead of <em>GSM</em> or <em>ZigBee</em>, reporting the same results while using a different
medium of transportation. Collected data is stored in the same database as
existing nodes, theoretically allowing a migration over time without changing
work flows.</p>
<h2 id=aim>Aim</h2>
<p>This work focuses unlike related scientific papers on a reproducible manual of
said sensor setups. Multiple papers in the <a href=#related-work>Related Work</a> section
prove the usability of LoRaWAN as a concept and specifically for the <em>Internet
of Things</em> and <em>sensor network</em> use case.</p>
<p>Specific steps to deploy a <em>sensor network</em> are described to combine available
resources to a working, low-cost live monitoring system with possible data
science pipelines.</p>
<p>Specifically, the described sensor node would cost around $50 including case,
microcontroller, custom PCB, battery as well as a temperature and rain-gauge
sensor. This approach allows either a higher resolution of measurements or
hobbyist scientists to run their own sensor node, allowing the contributing of
measurements without larger investments.</p>
<h2 id=structure>Structure</h2>
<p>Within this document no specifics of the LoRaWAN protocol are covered. For
technical details on the LoRa frequency modulation or the LoRaWAN stack the
<a href=#related-work>Related Work</a> section gives further information.</p>
<p>In the <a href=#hardware>Hardware section</a> used microcontrollers and LoRaWAN gateways
are covered. Additional documentation is provided on the custom designed
<em>Printed circuit board</em> (PCB) as well as the used outdoor casing.</p>
<p>The <a href=#software>Software</a> section describes all code and tooling used and
created within this project. Multiple sub-sections describe the full setup in
detail and should be followed in that order.</p>
<p>Within the brief <a href=#resources>Resources section</a> the advantages of the <em>Cayenne
Low Power Protocol</em> for data transmission as well as an overview of used sensors
for multiple environmental metrics are discussed are discussed.</p>
<h2 id=related-work>Related Work</h2>
<p>Using LoRaWAN for sensor networks is not a new idea and multiple papers describe
a variety of experiments<a href=#references>[1]</a>. Also the technology of LoRa
frequency modulation as well as the LoRaWAN stack was discussed in multiple
publications<a href=#references>[2]</a>.</p>
<p>This projects is similar to work of <em>Davec et al</em><a href=#references>[3]</a> where they
proof the feasibility of sensors over large distances gathering environmental
metrics, in their case specifically temperature and soil moisture.</p>
<p>Next to academic publications this work is based on free documentation available
online, notably the <a href=https://www.arduino.cc/reference/en/>Arduino Reference</a> and the many code
examples by <em>HelTec Inc.</em> within their <a href=https://github.com/HelTecAutomation/CubeCell-Arduino/tree/master/libraries>CubeCell
repository</a>.</p>
<p>Low-cost weather stations based on Arduino with custom circuit boards were also
described by the <a href=https://openweatherstation.com/ows/index.php#wifi-and-cell-phone-network>OpenWeatherStation project</a> and
<a href=https://www.dfrobot.com/blog-465.html>DFRobot</a>, however neither uses LoRaWAN and is therefore more bound to
local installations.</p>
<p>Complete setups from specialized vendors like <a href=https://www.onsetcomp.com/support/application_solutions/weather-station-kits/>Onset Computer
Corporation</a> offer professional weather stations, however come at a
much higher price tag as solutions within this project.</p>
<h1 id=hardware>Hardware</h1>
<p>Within this section all hardware like microcontrollers, LoRaWAN base stations
and outdoor casing are described.</p>
<h2 id=microcontroller>Microcontroller</h2>
<p>This section describes the used microcontrollers and development boards used
within this setup. The microcontrollers is essentially an extremely small
computer with hardware inputs and outputs. In simple terms, sensors are attached
to the inputs and a LoRaWAN radio frequency module is connected to the outputs.</p>
<p>Using microcontrollers comes in two flavors, either as development boards with
populated connectors, for instance a USB port and attached LEDs or as a plain
module, which requires designing of a custom PCB. The former is used for rapid
prototyping while the latter runs on an optimized PCB which only contains
required functionality.</p>
<p>To simplify the development only microcontrollers compatible with the <a href=https://www.arduino.cc/>Arduino
framework</a> were considered. The framework abstracts talking to low
level hardware components and offers a simple C API to control the
microcontrollers behaviour. Additionally this allows to migrate code from one
device to another with minimal code modifications since both devices understand
the same API.</p>
<p>Due to low price and using the LoRaWAN reference implementation the <em>CubeCell</em>
product line from the vendor <a href=https://heltec.org/proudct_center/lora/cubecell/><em>Heltec Automation</em></a> were found ideal for
initial development. Both offered development boards <em>CubeCell Dev-Board</em>
(<code>htcc-ab01</code>) and <em>CubeCell Dev-Board Plus</em> (<code>htcc-ab02</code>) as well as the plain
<em>Module Plus</em> (<code>htcc-am02</code>) were used within this project.</p>
<h3 id=heltec-cubecell-dev-board-plus>Heltec CubeCell Dev-Board (Plus)</h3>
<p><img src=img/heltec_cubecell_dev_board.png#floatright alt="Dev Board"></p>
<p><img src=img/heltec_cubecell_dev_board_plus.png#floatright alt="Dev Board Plus"></p>
<p>The development boards shown on the right both allow to connect sensors via
<em>GPIO Pins</em> as well as <a href=https://www.arduino.cc/en/reference/wire><em>I2C</em></a> or serial console. Only the bigger <em>Plus</em>
versions (bottom) contains two <em>Analog to Digital Converter</em> (ADC) which are
required for some sensor like the <em>VH400</em> moisture sensor.</p>
<p>Additionally the <em>Plus</em> version comes with an attached LCD display which can be
used for debugging or additional information during setup. No long time tests
were performed to evaluate the UV resistance of the display.</p>
<p>For outdoor setups they come with a solar charge controller and battery
connector which allows the usage without a constant power supply.</p>
<p>Both boards use the same microcontroller and can run the same code.</p>
<p>Flashing is trivial by using the USB connection and the
<a href=#platformio>Platformio framework</a>.</p>
<ul>
<li><a href=files/heltec_htcc-ab01_pinout.pdf>Dev-Board Pinout</a></li>
<li><a href=files/heltec_htcc-ab02_pinout.pdf>Dev-Board Plus Pinout</a></li>
</ul>
<h3 id=heltec-cubecell-module-plus>Heltec CubeCell Module Plus</h3>
<p><img src=img/heltec_htcc-am02.png#floatright alt="Module Plus"></p>
<p>The <em>Module Plus</em> allows (and requires) to use custom PCB and therefore only runs
parts that are required. For production deployments the nodes would not need a
LCD screen for debugging or a USB port for flashing. These components can simply
be removed in the PCB design which reduces the number or parts, thereby cost and
complexity.</p>
<p><em>Dev-Board Plus</em> and <em>Module Plus</em> use the same microcontroller and therefore
support the same connections.</p>
<p>More information on the PCB required for the <em>Module Plus</em> is available in the
<a href=#pcb>PCB</a> section.</p>
<ul>
<li><a href=files/heltec_htcc-am02_pinout.pdf>Module Plus Pinout</a></li>
</ul>
<h2 id=gateways>Gateways</h2>
<p>While the <a href=#microcontroller>Microcontrollers</a> with an attached LoRaWAN radio
frequency module mostly sends data, the receiving part is called gateway.
Essentially it is a device with a LoRaWAN compatible receiver attached as well
as an Internet connection. Received packages are forwarded to a broker. More
details on that are available in the <a href=#thethingsnetwork>LoRaWAN section</a></p>
<p>Within this project the following three gateways were used as described below.
This was partly necessary as LoRaWAN coverage with TheThingsNetwork broker were
limited within the area of research, Honolulu, Ohau, Hawaii. At other locations
institutions or private entities may already provide coverage free of charge.
Using the <a href=https://ttnmapper.org/>TTNMapper</a> it&rsquo;s possible to see a local coverage map and
determine if a self maintained gateway is required.</p>
<h3 id=the-things-indoor-gateways>The Things Indoor Gateways</h3>
<p><img src=img/ttig.png#floatright alt="Indoor Gateway"></p>
<p>This gateway allows simple operation since it&rsquo;s developed by the same people as
the used LoRaWAN broker. It was used during local development and allows quick
migration between different locations. While not waterproof, using additional
casing and attaching an external antenna it can also be used as a outdoor
gateway. For mobile development it is possible to power the
gateway via a USB-C cable.</p>
<p>A complete install and maintenance guide is available in the <a href=https://www.thethingsindustries.com/docs/gateways/thethingsindoorgateway/>vendors
documentation</a> and is not replicated here.</p>
<h3 id=heltec-ht-m00>Heltec HT-M00</h3>
<p><img src=img/heltec_ht-m00.png#floatright alt=HT-M00></p>
<p>Just as the <a href=#microcontroller>microcontrollers</a> Heltec offers a development
gateway as <a href=https://heltec.org/project/ht-m00/>well</a>. At the time of writing this is the cheapest development
gateway available with a price of about $40. The <a href=https://heltec-automation-docs.readthedocs.io/en/latest/gateway/ht-m00/connect_to_server.html>upstream
documentation</a> guides through the installation process of the gateway
into TheThingsNetwork broker. For mobile development it is possible to power the
gateway via a USB-C cable.</p>
<h3 id=mikrotik-wap-lr9-kit>Mikrotik wAP LR9 kit</h3>
<p><img src=img/mikrotik_lr9_kit.png#floatright alt="wAP LR9 kit"></p>
<p>Lastly the outdoor LoRaWAN gateway from the vendor Mikrotik (in <a href=https://mikrotik.com/product/wap_lr9_kit>900MHz</a> or
<a href=https://mikrotik.com/product/wap_lr8_kit>860MHz</a>) offers the, at the time of writing, cheapest outdoor gateway.
With <em>Power over Ethernet</em> (PoE) the installation is possible with a single
Ethernet cable without requiring a power plug next the (ideally elevated)
deployment location.</p>
<h2 id=printed-circuit-board>Printed Circuit Board</h2>
<p>This section briefly describes the PCBs designed within this project. While
<a href=https://en.wikipedia.org/wiki/Breadboard>breadboards</a> are often used for prototyping with microcontroller, real
deployments should use custom PCBs since they offer a more reliable setup.</p>
<p>The project scope required a rain gauge sensor as well as a temperature sensor
to transmit measurements over LoRaWAN to a online database. With the below
described PCB it is possible to attach a <em>Heltec HTCC-AB02</em> as well as the two
sensors within minutes.</p>
<h3 id=rain-gauge-pcb><em>Rain Gauge</em> PCB</h3>
<p>As mentioned above the two values <em>temperature</em> and <em>rain fall</em> were to be
collected and send to an online database. First prototypes using a breadboard
and a <em>Heltec HTCC-AB02</em> worked out as expected, so the exactly the same circuit
was transfered in a PCB. Below a picture of the PCB is shown. The labels
<code>RAIN_GAUGE</code>, <code>SOLAR_IN</code> and <code>ONE_WIRE_IN</code> contain screw terminals which allow
easy attaching of the sensor cables.</p>
<p><img src=img/pcb_rain-box.png alt="Custom Rain Gauge Design"></p>
<p>The next image shows a printed and mostly assembled (missing 4.7k resistor)
board. The <em>CubeCell board</em> can be directly attached to the pin headers, the
labeled screw terminals allow a simple connection of sensors. Next to the
attached pin headers is a second row of pins which can be used for developing to
connect any other GPIO which might be of interest in the future.</p>
<p><img src=img/pcb_rain-box-real.png alt="Custom Rain Gauge Assembled"></p>
<p>An <a href=easyeda.com/>EasyEda</a> project file is available
<a href=files/rain-box_htcc-ab02-v0.3.zip>here</a> for customization or ordering
online.</p>
<p>Additionally the <em>BOM</em>, <em>Gerber</em> and <em>Pick & Place</em> files are available:</p>
<ul>
<li><a href=files/BOM_PCB_rain-box_htcc-ab02.csv>BOM_PCB_rain-box_htcc-ab02.csv</a></li>
<li><a href=files/Gerber_PCB_rain-box_htcc-ab02.zip>Gerber_PCB_rain-box_htcc-ab02.zip</a></li>
<li><a href=files/PickAndPlace_PCB_rain-box_htcc-ab02.csv>PickAndPlace_PCB_rain-box_htcc-ab02.csv</a></li>
</ul>
<p>The PCB has a custom cutting so it fits perfectly into the outdoor case
<a href="https://www.budind.com/product/nema-ip-rated-boxes/ptk-series-fiberglass-box/ptk-18240-2/#group=series-products&external_dimensions_group=0&internal_dimensions=0&cover_style_group=0">PTK-18420-C</a> by <em>Bud Industries, Inc.</em>. It is important to order the <code>C</code>
version since a <strong>clear cover</strong> is required to allow solar charging. Using cable
glands it&rsquo;s possible to connect external sensors. The picture below shows two
possible positions for <code>7mm</code> holes to attach <code>PG7</code> cable glands. Silicon was
added around the cable glands for better long term water resistance.</p>
<p><img src=img/box_holes.png alt="Drill Example for PTK-18420-C Box"></p>
<p>The full box specifications are available on the <a href="https://www.budind.com/product/nema-ip-rated-boxes/ptk-series-fiberglass-box/ptk-18240-2/#group=series-products&external_dimensions_group=0&internal_dimensions=0&cover_style_group=0">vendors website</a> or as
an attached <a href=files/box_hbptk18420.pdf>resource</a>.</p>
<p>It is possible to use the <em>Pick and Place</em> file to order all parts soldered on
or solder all components manually. In that case a <code>4.7K</code> resistor should be
added on the bottom left instead of a flat resistor.</p>
<p>A picture of an assembled <em>Rain Box</em> is shown below. The picture shows four
different setups of the rain gauges.</p>
<ul>
<li>The <strong>left box</strong> has a <a href=https://www.onsetcomp.com/products/data-loggers/rg3/>HOBO RG3 rain gauge</a></li>
<li>The <strong>middle box</strong> has only a <a href=https://www.adafruit.com/product/381>DS18B20 temperature sensor</a> is
connected inside the box. This was done to measure the maximum daily
temperature inside the box.</li>
<li>The <strong>right box</strong> has both a temperature sensor and a <a href=https://www.amazon.com/MISOL-Spare-weather-station-measure/dp/B00QDMBXUA/>MISOL rain
guage</a> attached. By the time of writing (2021-09-16) the official
vendor website is unreachable.</li>
<li>In <strong>front</strong> is a PCB board without a box showing a connected <em>Heltec
HTCC-AB02</em>.</li>
</ul>
<p><img src=img/rain-box-setup.jpeg alt="Rain Gauge Setup"></p>
<h3 id=pcb-editor>PCB Editor</h3>
<p>To design PCBs a variety of tools is available for free. However the number of
tools that are available on the three main platforms Windows, MacOSX and Linux
is limited. Within this project <a href=easyeda.com/>EasyEda</a> was used for it&rsquo;s simple usage
and integration with part libraries, which would simplify the ordering process.</p>
<p>EasyEda comes with a tight integration of the PCB vendor <em>JLCPCB</em> which offers
both creation of PCBs and also soldering of selected components.</p>
<p>An extensive official documentation is available in English on the <a href=https://docs.easyeda.com/en/FAQ/Editor/index.html>vendors
website</a> include <a href=https://www.youtube.com/channel/UCRoMhHNzl7tMW8pFsdJGUIA/videos>video tutorials</a>.</p>
<p><img src=img/easyeda.png alt="EasyEda PCB Designer"></p>
<p>If EasyEda is not an option the open source tools <a href=https://librepcb.org/download/>LibrePCB</a> or
<a href=https://www.kicad.org>KiCad</a> could be used instead, however they are not covered here.</p>
<h1 id=software>Software</h1>
<p>This section describes all code and tooling used and created within this
project. It is recommended to read the <a href=#hardware>Hardware section</a> first to
have the required sensor nodes.</p>
<h2 id=thethingsnetwork>TheThingsNetwork</h2>
<p>This section gives a brief introduction to the free <em>TheThingsNetwork</em> service
which provides a <em>Network server</em> to handle LoRaWAN authentication, forwarding
and data access. More information on the LoRaWAN stack <em>Rizzi et
al</em><a href=#references>[2]</a> give a great introduction how communication from sensor node
to user facing <em>Application server</em> works.</p>
<p>In short, <em>TheThingsNetwork</em> is a free, partly commercial, partly community
driven service which handles the management of nodes, keys, base stations and
APIs to access collected data. The picture below shows a simplified overview of
the stack.</p>
<p><img src=img/lorawan.svg alt="The LoRaWAN stack"></p>
<p>Sensor <strong>Nodes</strong> collect data and send it via LoRa radio frequency modulation
(red lines) to <strong>Gateways</strong>. A gateway has a LoRa compatible radio module and
antenna attached and listens for incoming messages. Once received, messages are
forwarded to a broker or <strong>Network Server</strong>. The network server, in this setups
case thethingsnetwork.org, manages user accounts and <strong>applications</strong>. Each
application has multiple <strong>Nodes</strong> assigned with individual login credentials.
Forwarded messages from gateways are offered via <a href=https://mqtt.org>MQTT</a> to user of
specified application. User controlled <strong>Application Servers</strong> can listen to
MQTT streams and store sensor data for further processing.</p>
<p>No user can access applications of other users and all traffic, starting from
sensor nodes until the application server is encrypted. This allows a federation
of infrastructure since multiple entities can share access to a single gateway
without being able to manipulate each others data.</p>
<p>As an outcome, both private hobbyists and institutions like universities can
offer gateway access and thereby work together to cover large areas. Different
projects don&rsquo;t have to manage their infrastructure independently but can share
gateways. Since all traffic is encrypted and authenticated as defined by the
LoRaWAN standard, no code has to be written by users to allow secure
connections.</p>
<p>Lastly multiple integrations allow even easier setups than described within this
document. Instead of running a self managed database, it is also possible to
rely on cloud services storing MQTT messages and offering convenient interfaces.</p>
<h3 id=web-interface-console>Web interface (Console)</h3>
<p>The cloud service requires a free online account and the setup of an
<strong>Application</strong>. Each application then contains multiple <strong>End devices</strong> which
which provide sensor data. Received data is offered via an MQTT API can should
be consumed by a user controlled database, in this setup <a href=#influxdb>InfluxDB</a>
or one of the integrations.</p>
<p>Within this project the <a href=https://nam1.cloud.thethings.network/console/><em>North American Cloud</em> (nam1)</a> was used, other
locations should use <em>Europe 1</em> (eu1) or <em>Australia 1</em> (au1). While the outdated
v2 stack is still offered, it <strong>should not be used</strong> due to it&rsquo;s upcoming end of
life (December 2021). Many resources online still document the <em>v2</em> which should
be avoided.</p>
<p><img src=img/ttn_devices.png alt="TheThingsNetwork device overview"></p>
<p>The above image shows currently active end devices, their identifiers as well as
the time of the last received message.</p>
<p><img src=img/ttn_mqtt.png alt="TheThingsNetwork MQTT access"></p>
<p>Aboves picture shows the MQTT login credentials which can be either used within
the InfluxDB setup to have <a href=#installation-of-telegraf><em>Telegraf</em></a> listen to
MQTT and store data or for other applications.</p>
<p>In the code appendix is a short Python script called
<a href=#mqtt2jsonpy><code>mqtt2json.py</code></a> which listens to the MQTT stream and outputs
lines of JSON which can be consumed by other applications. A generic script
like this allows custom downstream handling of incoming sensor data. As proof of
concept the script below is parsed by another tool adding measurements to a SQL
database and visualize them via a <a href=https://grogdata.soest.hawaii.edu/staging/nodepage/node-301/>custom web page</a>. Nodes are
identified via the <code>from</code> field and all payload is stored in the <code>p</code> field,
containing data fields based on <a href=#cayenne>CayenneLPP</a>.</p>
<p>Below is an example output of the script which could be read by future tooling
using the <a href=https://jsonlines.org/><em>JSON Lines</em> standard</a></p>
<pre tabindex=0><code>{&quot;from&quot;: &quot;rain-box-5&quot;, &quot;p&quot;: {&quot;temperature_1&quot;: 23.1}}
{&quot;from&quot;: &quot;rain-box-1&quot;, &quot;p&quot;: {&quot;temperature_1&quot;: 23.5}}
{&quot;from&quot;: &quot;sonic-2&quot;, &quot;p&quot;: {&quot;distance_1&quot;: 4.991}}
{&quot;from&quot;: &quot;rain-box-6&quot;, &quot;p&quot;: {&quot;temperature_1&quot;: 21.4}}
{&quot;from&quot;: &quot;rain-box-4&quot;, &quot;p&quot;: {&quot;digital_out_1&quot;: 2, &quot;voltage_1&quot;: 4.15}}
{&quot;from&quot;: &quot;sonic-2&quot;, &quot;p&quot;: {&quot;distance_1&quot;: 5}}
{&quot;from&quot;: &quot;rain-box-5&quot;, &quot;p&quot;: {&quot;digital_out_1&quot;: 2, &quot;voltage_1&quot;: 4.22}}
{&quot;from&quot;: &quot;sonic-2&quot;, &quot;p&quot;: {&quot;distance_1&quot;: 5}}
{&quot;from&quot;: &quot;rain-box-4&quot;, &quot;p&quot;: {&quot;temperature_1&quot;: 24.7}}
{&quot;from&quot;: &quot;rain-box-5&quot;, &quot;p&quot;: {&quot;temperature_1&quot;: 23.6}}
{&quot;from&quot;: &quot;rain-box-1&quot;, &quot;p&quot;: {&quot;temperature_1&quot;: 23.6}}
{&quot;from&quot;: &quot;sonic-2&quot;, &quot;p&quot;: {&quot;distance_1&quot;: 5}}
{&quot;from&quot;: &quot;rain-box-6&quot;, &quot;p&quot;: {&quot;temperature_1&quot;: 21.5}}
{&quot;from&quot;: &quot;rain-box-3&quot;, &quot;p&quot;: {&quot;temperature_1&quot;: 24.1}}
{&quot;from&quot;: &quot;sonic-2&quot;, &quot;p&quot;: {&quot;distance_1&quot;: 5}}
{&quot;from&quot;: &quot;sonic-2&quot;, &quot;p&quot;: {&quot;distance_1&quot;: 5}}
{&quot;from&quot;: &quot;rain-box-4&quot;, &quot;p&quot;: {&quot;temperature_1&quot;: 24.6}}
{&quot;from&quot;: &quot;rain-box-5&quot;, &quot;p&quot;: {&quot;temperature_1&quot;: 23}}
{&quot;from&quot;: &quot;rain-box-1&quot;, &quot;p&quot;: {&quot;temperature_1&quot;: 23.7}}
...
</code></pre><h2 id=platformio>Platformio</h2>
<p>This section describes the usage of the <em>Platformio</em> framework for embedded
development. Similar to the <a href=https://www.arduino.cc/en/software/><em>Arduino IDE</em></a> it allows the management of
dependencies and compilation for a wide variety of devices.</p>
<p>Due to its simple installation and full support for the used hardware it was
preferred over other the <em>Arduino IDE</em>, however other tooling should be possible
as well.</p>
<h3 id=installation>Installation</h3>
<p>A full installation guide is available in the <a href=https://docs.platformio.org/en/latest//core/installation.html>upstream documentation</a>
however the basic installation boils down to a running Python 3 installation
combined with the Python Packet Manager or <code>curl</code>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>pip install -U platformio

<span style=color:#60a0b0;font-style:italic># or</span>

python3 -c <span style=color:#4070a0>&#34;</span><span style=color:#007020;font-weight:700>$(</span>curl -fsSL https://raw.githubusercontent.com/platformio/platformio/master/scripts/get-platformio.py<span style=color:#007020;font-weight:700>)</span><span style=color:#4070a0>&#34;</span>
</code></pre></div><p>After the installation the shortcut <code>pio</code> executes the binary.</p>
<h3 id=creating-a-project>Creating a project</h3>
<p>Adding projects is as easy as creating a folder and running <code>pio</code> to initialize
the project in the current folder.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir project/ <span style=color:#666>&amp;&amp;</span> <span style=color:#007020>cd</span> project/
pio project init
</code></pre></div><p>After the initialization the following files are created:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>include/       <span style=color:#60a0b0;font-style:italic># header files</span>
lib/           <span style=color:#60a0b0;font-style:italic># libraries</span>
platformio.ini <span style=color:#60a0b0;font-style:italic># platformio configuration file</span>
src/           <span style=color:#60a0b0;font-style:italic># source code (e.g. main.cpp)</span>
test/          <span style=color:#60a0b0;font-style:italic># automatic tests</span>
</code></pre></div><h3 id=platformioini><code>platformio.ini</code></h3>
<p>The configuration file contains one or multiple environments per used device
type. Within this projects environments for the devices <code>cube_cell_board</code>,
<code>cubecell_board_plus</code> and <code>cubecell_module_plus</code> are used. The file below shows
one of the three environments and defines multiple aspects or the project which
simplify development:</p>
<ul>
<li><code>board_build.ardiono.*</code> defines values passed during compile time to enable
and configure specific features.</li>
<li><code>upload_port</code> defines the local connection, which allows to have multiple
devices connected at once and test them in parallel</li>
<li><code>lib_deps</code> defines all required dependencies which can be hosted within the
Platformio <a href=https://platformio.org/lib>registry</a> or Git repositories directly.</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#007020;font-weight:700>[env:cubecell_board_plus]</span>
<span style=color:#4070a0>board</span> <span style=color:#666>=</span> <span style=color:#4070a0>cubecell_board_plus</span>
<span style=color:#4070a0>platform</span> <span style=color:#666>=</span> <span style=color:#4070a0>asrmicro650x</span>
<span style=color:#4070a0>framework</span> <span style=color:#666>=</span> <span style=color:#4070a0>arduino</span>
<span style=color:#4070a0>board_build.arduino.lorawan.region</span> <span style=color:#666>=</span> <span style=color:#4070a0>US915</span>
<span style=color:#4070a0>board_build.arduino.lorawan.netmode</span> <span style=color:#666>=</span> <span style=color:#4070a0>OTAA</span>
<span style=color:#4070a0>board_build.arduino.lorawan.adr</span> <span style=color:#666>=</span> <span style=color:#4070a0>ON</span>
<span style=color:#4070a0>monitor_speed</span> <span style=color:#666>=</span> <span style=color:#4070a0>115200</span>
<span style=color:#4070a0>upload_port</span> <span style=color:#666>=</span> <span style=color:#4070a0>/dev/ttyUSB0</span>
<span style=color:#4070a0>lib_deps</span> <span style=color:#666>=</span> <span style=color:#4070a0>
</span><span style=color:#4070a0>	https://github.com/ElectronicCats/CayenneLPP.git#master
</span><span style=color:#4070a0>	bblanchon/ArduinoJson @ ^6.17.2
</span><span style=color:#4070a0>	practicalarduino/SHT1x@0.0.0-alpha+sha.be7042c3e3</span>
</code></pre></div><h3 id=flashing-nodes>Flashing nodes</h3>
<p>Once a sensor node is connected it can be flashed using the following command:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>pio run --target upload
</code></pre></div><p>For convenience it is also possible to upload and monitor the serial output at
once:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>pio run --target upload --target monitor
</code></pre></div><h2 id=sensor-node>Sensor Node</h2>
<p>This section describes the software used on sensor nodes. All code is deployed
on devices as described in the <a href=#platformio>Platformio section</a>. After flashing
nodes are provisioned using the <a href=#provision_nodepy><code>provision_node.py</code></a> script
in combination with YAML files containing the per device specific information.</p>
<p>The detail section below contain the following content:</p>
<ul>
<li><a href=#configh>config.h</a> contains node specific configuration options, like the
sensors to enable on which PINs. This should be modified per use case, for
instance when creating a new series of rain gauges measuring moisture as well,
the sensor should be enabled here. Per node configuration happens via the
<code>provision_node.py</code> script after flashing.</li>
<li><a href=#maincpp>main.cpp</a> contains the main loop which connects to sensors and
sends LoRaWAN packets.</li>
<li><a href=#vh400cpp>VH400.cpp</a> minimal library to communicate with <em>VH400</em> moisture
sensor.</li>
<li><a href=#mb7389cpp>MB7389.cpp</a> minimal library to communicate with <em>MB7389</em>
ultrasonic sensor.</li>
</ul>
<h3 id=using-provision_nodepy-for-at_commands>Using <code>provision_node.py</code> for <code>AT_Commands</code></h3>
<p>The <em>Heltec Dev Boards</em> allows the configuration of certain on-device variables
via <code>AT_Commands</code>. Those commands can be communicated via a serial connection
(e.g. over USB) and modify per-device specific LoRaWAN credentials or user
defined values.</p>
<p>A list of the most important <code>AT_Commands</code> is shown below:</p>
<table>
<thead>
<tr>
<th>AT Command</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>+LORAWAN=1</td>
<td>LoRaWAN 1, LoRa 0</td>
</tr>
<tr>
<td>+OTAA=1</td>
<td>OTAA -1, ABP-0</td>
</tr>
<tr>
<td>+Class=A</td>
<td>Class A or C</td>
</tr>
<tr>
<td>+ADR=1</td>
<td>1 on 0 for off</td>
</tr>
<tr>
<td>+IsTxConfirmed=1</td>
<td>LoRaWAN ACK Message 1 on, 0 off.</td>
</tr>
<tr>
<td>+AppPort=2</td>
<td>The Application Port 2 for general APPs and 10 for TTN MAPPER.</td>
</tr>
<tr>
<td>+DutyCycle=60000</td>
<td>The time between transmission in mS. Typically, 15000 to 3600000</td>
</tr>
<tr>
<td>+DevEui=???</td>
<td>Unique (OTAA Mode)</td>
</tr>
<tr>
<td>+AppEui=???</td>
<td>Unique (OTAA Mode)</td>
</tr>
<tr>
<td>+AppKey=???</td>
<td>Unique (OTAA Mode)</td>
</tr>
<tr>
<td>+ChipID=?</td>
<td>get ChipID</td>
</tr>
<tr>
<td>+JOIN=1</td>
<td>start join</td>
</tr>
</tbody>
</table>
<p>To allow managing multiple devices YAML configuration files are used containing
credentials of nodes. After flashing a node via <a href=#platformio>Platformio</a> a node
can be configured by running a command like the following:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>python provision_node<span style=color:#666>.</span>py rain<span style=color:#666>-</span>box<span style=color:#666>-</span><span style=color:#40a070>1</span>
</code></pre></div><p>Below is an illustrative content of <code>./nodes/rain-box-1.yml</code>. All contents of
the <code>at_commands</code> dictionary are executed via the provision script. All other
values like <code>case</code> and <code>sensors</code> can be used to keep an inventory in a
machine-readable format.</p>
<p>The special value <code>mmPerTip</code> is a <em>user</em> <code>AT_Commands</code> which is defined within
<code>main.cpp</code> and determines how many millimeters a rain gauge tip adds to the
total value.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#062873;font-weight:700>case</span>:<span style=color:#bbb> 
</span><span style=color:#bbb>  </span><span style=color:#062873;font-weight:700>type</span>:<span style=color:#bbb> </span>PTK-18420-C<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#062873;font-weight:700>label</span>:<span style=color:#bbb> </span>rain-box-1<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#062873;font-weight:700>sensors</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- HOBO RG-3<span style=color:#bbb>
</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#062873;font-weight:700>at_commands</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#062873;font-weight:700>DevEui</span>:<span style=color:#bbb> </span>0025307XXXXXXXXX<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#062873;font-weight:700>AppEui</span>:<span style=color:#bbb> </span>70B3D57ED003A1D1<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#062873;font-weight:700>AppEui</span>:<span style=color:#bbb> </span>70B3D57XXXXXXXXX<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#062873;font-weight:700>AppKey</span>:<span style=color:#bbb> </span>1F41DD0XXXXXXXXXXXXXXXXXXXXXXXXX<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#062873;font-weight:700>mmPerTip</span>:<span style=color:#bbb> </span><span style=color:#40a070>0.3851</span><span style=color:#bbb>
</span></code></pre></div><h2 id=influxdb-database>InfluxDB Database</h2>
<p>This sections covers briefly the setup of InfluxDB, a time series database which
allows storing and querying metrics. Just like all other tools used within this
document it&rsquo;s open source and all <a href=https://github.com/influxdata/influxdb/>code is available online</a>.</p>
<p>Using InfluxDB comes with the two advantages of offering integrations for both
<a href=#grafana>Grafana</a> as well consuming MQTT events, which is the way the
<a href=#thethingsnetwork>LoRaWAN brooker</a> reports metrics.</p>
<h3 id=installation-of-influxdb>Installation of InfluxDB</h3>
<blockquote>
<p>While InfluxDB 2.0 was released this year, this document describes the setup and
usage of InfluxDB 1.8. All tooling should be compatible with both versions and a
migration guide might be added later on.</p>
</blockquote>
<p>The upstream documentation explains the installation process for various setups,
for the RaspberryPi setup the <a href=https://docs.influxdata.com/influxdb/v1.8/introduction/install/>Ubuntu & Debian</a> steps should
be followed. Within this documentation both database and user are called
<code>telegraf</code>, however other use cases may use other values.</p>
<h3 id=installation-of-telegraf>Installation of Telegraf</h3>
<blockquote>
<p>Telegraf is used to consume MQTT events and store them inside InfluxDB.</p>
</blockquote>
<p>InfluxDB and Telegraf are both developed by <em>InfluxData Inc.</em>, so a similar
installation process is offered. Again the official installation guide for
<a href=https://docs.influxdata.com/telegraf/v1.19/introduction/installation/>Ubuntu & Debian</a> should be used.</p>
<p>Once installed a custom configuration is required to consume data from
TheThingsNetwork and store them locally. All values in <code>&lt;...></code> should be changed
accordingly to the actual setup.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=color:#60a0b0;font-style:italic># /etc/telegraf/telegraf.conf</span>
[global_tags]
[agent]
  interval = <span style=color:#4070a0>&#34;10s&#34;</span>
  round_interval = <span style=color:#007020;font-weight:700>true</span>
  metric_batch_size = <span style=color:#40a070>1000</span>
  metric_buffer_limit = <span style=color:#40a070>10000</span>
  collection_jitter = <span style=color:#4070a0>&#34;0s&#34;</span>
  flush_interval = <span style=color:#4070a0>&#34;10s&#34;</span>
  flush_jitter = <span style=color:#4070a0>&#34;0s&#34;</span>
  precision = <span style=color:#4070a0>&#34;&#34;</span>
  hostname = <span style=color:#4070a0>&#34;&#34;</span>
  omit_hostname = <span style=color:#007020;font-weight:700>false</span>

[[outputs.influxdb]]
  database = <span style=color:#4070a0>&#34;telegraf&#34;</span>
  urls = [ <span style=color:#4070a0>&#34;http://localhost:8086&#34;</span> ]
  username = <span style=color:#4070a0>&#34;&lt;influxdb_username&gt;&#34;</span>
  password = <span style=color:#4070a0>&#34;&lt;influxdb_password&gt;&#34;</span>

[[inputs.mqtt_consumer]]
  servers = [<span style=color:#4070a0>&#34;tcp://nam1.cloud.thethings.network:1883&#34;</span>]                                              
  topics = [ <span style=color:#4070a0>&#34;#&#34;</span> ]
  username = <span style=color:#4070a0>&#34;&lt;thethingsnetwork_username&gt;&#34;</span>
  password = <span style=color:#4070a0>&#34;NNSXS.&lt;thethingsnetwork_api_token&gt;&#34;</span>
  data_format = <span style=color:#4070a0>&#34;json&#34;</span>
  tag_keys = [
    <span style=color:#4070a0>&#34;end_device_ids_device_id&#34;</span>
  ]
</code></pre></div><p>Once both services are running one should proceed setting up
<a href=#grafana>Grafana</a> to create a dashboard presenting collected metrics.</p>
<h2 id=grafana-dashboard>Grafana Dashboard</h2>
<p>Presenting collected data is important to make them accessible and give an
overview of events before starting in-depths analytics. While multiple
approaches to visualize data exists, this section describes the setup of
Grafana.</p>
<p>The advantages of Grafana compared to other solutions is the fact that without
any coding skills appealing graphs and gauges can be created, offering a live
and interactive user interface.</p>
<p>Within this setup the combination with the <a href=#influxdb>InfluxDB database</a> is
described, however it is possible to visualize <a href=https://grafana.com/docs/grafana/latest/datasources/>other data sources</a>
via Grafana.</p>
<h3 id=installation-1>Installation</h3>
<p>To allow a cheap and reproducible setup these steps are done on a RaspberryPi
running <a href=https://www.raspberrypi.org/downloads/raspbian/>Raspbian</a>, which allows low cost data hosting without
requiring any server setups. However it is equally possible to run this on a
virtual machine or even a laptop for testing.</p>
<p>The Raspbian ports of Grafana are outdated and therefore the official
Grafana repository is used instead:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#007020>echo</span> <span style=color:#4070a0>&#34;deb https://packages.grafana.com/oss/deb stable main&#34;</span> | <span style=color:#4070a0;font-weight:700>\d</span>ocs
	sudo tee -a /etc/apt/sources.list.d/grafana.list 
wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -
sudo apt update
sudo apt install -y grafana-rpi
</code></pre></div><p>More details on the Grafana installation steps are available in the official
<a href=https://grafana.com/docs/grafana/latest/installation/debian/>documentation</a>.</p>
<h3 id=adding-influxdb-as-data-source>Adding InfluxDB as data source</h3>
<p>This setup run both Grafana as well as InfluxDB on a single RaspberryPi.
Therefore it&rsquo;s possible to access the data locally. Other setups may use remote
database on distributed systems, where data is stored on different machines than
visualized.</p>
<p><img src=img/grafana_datasource.png alt="Grafana add datasource"></p>
<p>InfluxDB runs per default on port <code>8086</code> and if running, is available on
<code>localhost</code>. None of the extra options need to be activated since a local setup
doesn&rsquo;t require extra authentication settings except the login credentials set
in the <a href=#influxdb>InfluxDB database</a> setup.</p>
<h3 id=configure-a-graphs>Configure a graphs</h3>
<p>A generic manual to add graphs or <em>panels</em> is provided by the Grafana Project
itself within their <a href=https://grafana.com/docs/grafana/latest/panels/add-a-panel/>documentation</a>.</p>
<p>This example describes how to get the battery voltage of all available nodes.
A running InfluxDB receives data via <em>Telegraf</em>, feeding a MQTT stream into the
time series database. If using the same options as in the InfluxDB section,
Grafana will present a <code>mqtt_consumer</code> table from which data can be selected.</p>
<p>Since the <a href=#cayennelpp>CayenneLPP</a> protocol is used to encode senor
data for LoRaWAN transmission, all fields in the table follow a specific schema:</p>
<pre tabindex=0><code>uplink_message_decoded_payload_&lt;cayennelpp_type&gt;_&lt;cayennelpp_id&gt;
</code></pre><p>All metrics start with <code>uplink_message_decoded_payload</code> since that contains
transmissions from the node. Other fields may contain IDs of used gateways or
transmission quality (<code>uplink_message_rx_metadata_0_rssi</code>), however these are
more relevant to monitor the nodes <em>health</em>.</p>
<p>The field of our interest is voltage with the ID <code>1</code>, the field is therefore
called as follows:</p>
<pre tabindex=0><code>uplink_message_decoded_payload_voltage_1
</code></pre><p>Once the field is selected measurements should be <em>grouped by</em> the device IDs.
&ldquo;Grouping by&rdquo; means that a graph is created per device instead of showing all
data in a single graph. The <em>tag</em> for grouping is called
<code>end_device_ids_device_id</code>.</p>
<p>Lastly to improve readability it is possible to assign an <em>alias</em> to each graph.
Instead of having the lengthy full description of a measurement (see below) only
the device identifier can be shown. To do so the special value
<code>$tag_end_device_ids_device_id</code> is added to the <em>alias</em> field.</p>
<pre tabindex=0><code>mqtt_consumer.uplink_message_decoded_payload_voltage_1 {end_device_ids_device_id: rain-box-6}
</code></pre><p><img src=img/grafana_add_voltage.png alt="Grafana modifying graph battery voltage"></p>
<h3 id=example-dashboard>Example Dashboard</h3>
<p>Below is a screenshot of a demo setup which includes two graphs of measured
metrics (rain fall and temperature) and below an overview of the nodes over the
last week. It is possible to interactively select smaller and bigger time frames
and see precise values for specific times and dates.</p>
<p><img src=img/grafana_rain_temperature.png alt="Grafana graph showing rain and temperature"></p>
<p>Aboves two graphs show rain events that happened at different location in
Honolulu, Hawaii. It&rsquo;s possible to zoom into specific time ranges to see the
total amount of rain for that day, hour or minute. Rain fall is reported only on
rainfall to reduce the amount of sent messages. In case of rain event a minutely
average is reported. The graph above shows a rain shower which triggered tips
over multiple minutes.</p>
<p>The temperature graph below the <em>rain fall</em> shows a repeating pattern of
temperature changes. Two special cases are handled in this graph showing where
<code>rain-box-1</code> shows the <em>inner enclosing temperature</em> and <code>rain-box-6</code> is
stationed in a cooled lab, therefore the constantly low temperature.</p>
<p>Additional values can be measured to track the <em>health</em> of sensors, most
importantly the battery voltages and connection quality (<em>RSSI</em>).</p>
<p><img src=img/grafana_voltage.png alt="Grafana graph showing battery voltage"></p>
<p>The graph above shows how the battery voltage is dropping every night but
recharged on sunrise.</p>
<p><img src=img/grafana_voltage_low.png alt="Grafana graph showing low battery voltage"></p>
<p>On the contrary, above graphs show that the node <code>sonic-2</code> doesn&rsquo;t recharge via
it&rsquo;s attached solar panel and therefore shuts off once the battery voltage is to
low for further LoRa transmissions. The node need manual inspection and
probably a solar panel replacement.</p>
<p><img src=img/grafana_rssi.png alt="Grafana graph showing RSSI values"></p>
<p>The graph above shows shows the varying values of RSSI, which describes the
connection quality. For LoRa values down to <strong>-120dB</strong> are fine for a stable
connection, so the node <code>rain-box-1</code> should have a stable connection.</p>
<h1 id=resources>Resources</h1>
<h2 id=cayennelpp>CayenneLPP</h2>
<p>This section explain CayenneLPP (Low Power Protocol) which is used to encode
data on sensor nodes into a size efficient format and decode it in the backend
back for further processing.</p>
<p><em>Cayenne</em> is a platform developed by <a href=https://developers.mydevices.com/cayenne/features/><em>myDevices Inc.</em></a> offering
custom dashboards for device monitoring, alerts and more. They developed
<a href=https://developers.mydevices.com/cayenne/docs/lora/#lora-cayenne-low-power-payload>CayenneLPP</a> and multiple open source implementation (<a href=https://github.com/ElectronicCats/CayenneLPP/>C</a>,
<a href=https://github.com/smlng/pycayennelpp>Python</a>) of that protocol exists. The protocol allows a compromise between
self describing data packets and size efficiency, which will be explained in the
next section.</p>
<p>This sections below show three ways to encode node data to a binary format for
sending over LoRa, a custom <em>raw</em> format, <em>JSON</em> and CayenneLPP. The example
data is a <strong>temperature</strong> value of 18.6 degree Celsius, a <strong>battery voltage</strong> of
3.9V and a <strong>distance</strong> value of 43mm.</p>
<h3 id=encoding-using-raw-bits>Encoding using raw Bits</h3>
<p>The smaller a LoRaWAN packet is the less power is required to send it and the
more airtime is available for other sensors. A simple solution would be just to
store all sensor data as binary fields one after another. The packet could have
the following format:</p>
<pre tabindex=0><code>&lt;temperature&gt;&lt;voltage&gt;&lt;distance&gt;
</code></pre><p>Representing floats in binary isn&rsquo;t trivial so instead a prevision can be
defined. For <strong>temperature</strong> two float digits are enough, for <strong>battery
voltage</strong> a single float digit is fine and <strong>dinstance</strong> is always a integer.</p>
<p>This means values can be multiple by <code>100</code> respectively <code>10</code>. The temperature
value becomes <code>1860</code> and the voltage becomes <code>39</code>. Both considering that
measured temperature will never be above 99.99 degree Celsius and battery
voltage should exceed 9.9V (4.2V really). For distance a maximum of 5000mm
should be used.</p>
<p>To calculate the maximum bits needed data, the maximum values are converted to
binary format and the required bits are counted, easily possible with some
Python:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=color:#666>&gt;&gt;&gt;</span> <span style=color:#007020>format</span>(<span style=color:#40a070>9999</span>, <span style=color:#4070a0>&#34;b&#34;</span>) <span style=color:#60a0b0;font-style:italic># max value</span>
<span style=color:#4070a0>&#39;10011100001111&#39;</span>
<span style=color:#666>&gt;&gt;&gt;</span> <span style=color:#007020>len</span>(<span style=color:#007020>format</span>(<span style=color:#40a070>9999</span>, <span style=color:#4070a0>&#34;b&#34;</span>))
<span style=color:#40a070>14</span>
<span style=color:#666>&gt;&gt;&gt;</span> <span style=color:#007020>format</span>(<span style=color:#40a070>99</span>, <span style=color:#4070a0>&#34;b&#34;</span>) <span style=color:#60a0b0;font-style:italic># max value</span>
<span style=color:#4070a0>&#39;1100011&#39;</span>
<span style=color:#666>&gt;&gt;&gt;</span> <span style=color:#007020>len</span>(<span style=color:#007020>format</span>(<span style=color:#40a070>99</span>, <span style=color:#4070a0>&#34;b&#34;</span>))
<span style=color:#40a070>7</span>
<span style=color:#666>&gt;&gt;&gt;</span> <span style=color:#007020>format</span>(<span style=color:#40a070>5000</span>, <span style=color:#4070a0>&#34;b&#34;</span>) <span style=color:#60a0b0;font-style:italic># max value</span>
<span style=color:#4070a0>&#39;1001110001000&#39;</span>
<span style=color:#666>&gt;&gt;&gt;</span> <span style=color:#007020>len</span>(<span style=color:#007020>format</span>(<span style=color:#40a070>5000</span>, <span style=color:#4070a0>&#34;b&#34;</span>))
<span style=color:#40a070>13</span>
<span style=color:#666>&gt;&gt;&gt;</span> 
</code></pre></div><p>Above calculation shows that <strong>14</strong> Bits are needed for temperature, <strong>7</strong> for
battery voltage and <strong>13</strong> for distance. Now the custom data format becomes more
specific as shown below:</p>
<pre tabindex=0><code>| temperature 14 | volt 7  | distance 13   |
| xxxxxxxxxxxxxx | xxxxxxx | xxxxxxxxxxxxx |
</code></pre><p>Below we calculate the specific values and pad them with zeros.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python3 data-lang=python3><span style=color:#666>&gt;&gt;&gt;</span> <span style=color:#007020>format</span>(<span style=color:#40a070>1860</span>, <span style=color:#4070a0>&#34;b&#34;</span>)
<span style=color:#4070a0>&#39;11101000100&#39;</span>
<span style=color:#666>&gt;&gt;&gt;</span> <span style=color:#007020>format</span>(<span style=color:#40a070>39</span>, <span style=color:#4070a0>&#34;b&#34;</span>)
<span style=color:#4070a0>&#39;100111&#39;</span>
<span style=color:#666>&gt;&gt;&gt;</span> <span style=color:#007020>format</span>(<span style=color:#40a070>43</span>, <span style=color:#4070a0>&#34;b&#34;</span>)
<span style=color:#4070a0>&#39;101011&#39;</span>
</code></pre></div><p>The resulting packet would look like this with a total size of <strong>34 Bits</strong>.</p>
<pre tabindex=0><code>| temperature 14 | volt 7  | distance 13   |
| 00011101000100 | 0101011 | 0000000101011 |
</code></pre><p>The receiving backend could decode this data by reading the first 14 Bits as
integer and dividing the value by 100 to calculate the temperature, followed by
reading Bit 15 until 21 as integer and dividing it by 10 to calculate the
battery voltage. The remaining 13 Bit can be directly read as distance.</p>
<p>While this approach works and data is efficiently exchanged between sensor node
and backend, the calculation is not trivial to understand. More problematic is
the extendability of this approach: Newly added sensors may use a different
set of sensors and therefore require data fields. As the exchanged data is just
Bits, it&rsquo;s not possible to know what the data contains. In other words, the
format is extremely static and ideally the data would be more self explaining so
a backend would know what value it is decoding.</p>
<h3 id=encoding-using-json>Encoding using JSON</h3>
<p>The JSON format is extremely popular in web application to exchange all kinds of
data. It is human readable, supports all our data types directly (float and
integer) and allows to verbosely describe data fields. The example data could be
decoded as below:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
	<span style=color:#062873;font-weight:700>&#34;temperature_1&#34;</span>: <span style=color:#40a070>18.6</span>,
	<span style=color:#062873;font-weight:700>&#34;voltage_1&#34;</span>: <span style=color:#40a070>3.9</span>,
	<span style=color:#062873;font-weight:700>&#34;distance_1&#34;</span>: <span style=color:#40a070>43</span>
}
</code></pre></div><p>As printed above, the format would take a total of 73 Bytes (584 Bits) which is
nearly 20 times bigger than using the raw format. Even a slightly optimized
version as shown below would still require 28 Bytes (224 Bits) meaning 7 times
bigger.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{<span style=color:#062873;font-weight:700>&#34;t1&#34;</span>:<span style=color:#40a070>18.6</span>,<span style=color:#062873;font-weight:700>&#34;v1&#34;</span>:<span style=color:#40a070>3.9</span>,<span style=color:#062873;font-weight:700>&#34;d1&#34;</span>:<span style=color:#40a070>43</span>}
</code></pre></div><h3 id=encoding-using-cayennelpp>Encoding using CayenneLPP</h3>
<p>CayenneLPP uses a compromise of both approaches, the data is very compact while
being self descriptive. To archive that common measurement types are available
with a 1 Byte data type descriptor and a 1 Byte data type channel (or ID). Each
data type, be it temperature, GPS or relative humidity is described by a number
between 0 and 255, a official reference implementation is available in the
<a href=https://developers.mydevices.com/cayenne/docs/lora/#lora-cayenne-low-power-payload-reference-implementation-cayenne-lpp-cc-constants-definitions>Cayenne Docs</a>. Since all data types are based on <a href=https://technical.openmobilealliance.org/OMNA/LwM2M/LwM2MRegistry.html#extlabel>IPSO data
types</a> other implementations support <a href=https://github.com/ElectronicCats/CayenneLPP/blob/master/API.md#methods-add>additional values</a>, like
voltage, altitude and distance.</p>
<p>Adding those values on device is done by a creating a <code>CayenneLPP</code> frame and
adding values. More details are available in <a href=#sensor-node><code>main.cpp</code>
implementation</a>, however below is an simplified example.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C>CayenneLPP <span style=color:#06287e>lpp</span>(LORAWAN_APP_DATA_MAX_SIZE);      <span style=color:#60a0b0;font-style:italic>// create frame
</span><span style=color:#60a0b0;font-style:italic></span>lpp.addVoltage(<span style=color:#40a070>1</span>, getBatteryVoltage());         <span style=color:#60a0b0;font-style:italic>// add voltage
</span><span style=color:#60a0b0;font-style:italic></span>lpp.addDistance(<span style=color:#40a070>1</span>, distance);                   <span style=color:#60a0b0;font-style:italic>// add distance in mm
</span><span style=color:#60a0b0;font-style:italic></span>lpp.addTemperature(<span style=color:#40a070>1</span>, temperature);             <span style=color:#60a0b0;font-style:italic>// add temperature in Celsius
</span><span style=color:#60a0b0;font-style:italic></span>appDataSize <span style=color:#666>=</span> lpp.getSize();                    <span style=color:#60a0b0;font-style:italic>// calculate size
</span><span style=color:#60a0b0;font-style:italic></span>memcpy(appData, lpp.getBuffer(), appDataSize);  <span style=color:#60a0b0;font-style:italic>// copy Bytes to LoRaWAN packet
</span></code></pre></div><p>The same is possible to do via Python using the <a href=https://github.com/smlng/pycayennelpp><code>pycayennelpp</code></a> package:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>cayennelpp</span> <span style=color:#007020;font-weight:700>import</span> LppFrame

frame <span style=color:#666>=</span> LppFrame()
frame<span style=color:#666>.</span>add_temperature(<span style=color:#40a070>0</span>, <span style=color:#40a070>18.6</span>)
frame<span style=color:#666>.</span>add_distance(<span style=color:#40a070>1</span>, <span style=color:#40a070>43</span>)
frame<span style=color:#666>.</span>add_voltage(<span style=color:#40a070>1</span>, <span style=color:#40a070>3.9</span>)
buffer <span style=color:#666>=</span> <span style=color:#007020>bytes</span>(frame)
<span style=color:#007020>print</span>(<span style=color:#007020>len</span>(buffer))
</code></pre></div><p>The result are <strong>14 Bytes</strong> and thereby half the size of using JSON. For
measurements which are not directly supported by the implementations, like
<em>number of satelites</em> for GPS measurements, it is possible to use the commands
<code>addDigitalInput</code> or <code>addDigitalOutput</code> (unsigned 32 Bit Integer) and
<code>addAnalogInput</code> or <code>addAnalogOutput</code> (float with 3 decimals).</p>
<h3 id=decoding-in-backend>Decoding in Backend</h3>
<p>The receiving backend allows to decode incoming data before offering it via
MQTT. This is very useful because so different applications listening to the
MQTT stream can directly process the decoded payload rather than implementing
that per client, allowing as well to upgrade the communication used for nodes
without modifying clients.</p>
<p>TheThingsNetwork offers to automatically decode CayenneLPP frames using the
<em>Payload Formatter</em> menu entry.</p>
<p><img src=img/ttn_cayenne.png alt="TheThingsNetwork CayenneLPP deocder"></p>
<p>However, since TheThingsNetwork uses the reference implementation of <em>MyDevices</em>
they don&rsquo;t support decoding some additional data types, like distance. If these
measurements are used it is possible to use a custom JavaScript decoder as
offered by <em>ElectronicCats</em> to be used directly in TheThingsNetwork. The
<a href=https://github.com/ElectronicCats/CayenneLPP/tree/master/decoders><code>decoder.min.js</code></a> can be pasted into the text field of the <em>Payload
Formatter</em> menu entry:</p>
<blockquote>
<p>The <code>min</code> decoder version is required as TheThingsNetwork limits the total
size of decoding scripts and the formated version exceeds that limit.</p>
</blockquote>
<p><img src=img/ttn_javascript.png alt="TheThingsNetwork set JavaScript decoder"></p>
<h3 id=used-payload-types>Used payload types</h3>
<p>Within this project the following payload types and IDs are used.</p>
<table>
<thead>
<tr>
<th>JSON value</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>analog_in_1</code></td>
<td>rain mm/m</td>
</tr>
<tr>
<td><code>analog_in_2</code></td>
<td>soil moisture</td>
</tr>
<tr>
<td><code>digital_out_1</code></td>
<td>running software version (integer)</td>
</tr>
<tr>
<td><code>temperature_1</code></td>
<td>temperature</td>
</tr>
<tr>
<td><code>voltage_1</code></td>
<td>battery voltage</td>
</tr>
<tr>
<td><code>distance_1</code></td>
<td>distance to sea level</td>
</tr>
</tbody>
</table>
<h2 id=sensors>Sensors</h2>
<p>This section describes briefly sensors used within this project. All of them are
supported by the <em>Arduino</em> framework an can be connected in any variation to the
described <a href=#microcontroller>microcontrollers</a>.</p>
<h3 id=distance>Distance</h3>
<p>To measure the distance between a fixed point and sea level the ultrasonic
<strong>MB7389</strong> sensor from <em>MaxBotix Inc.</em> was used. It offers a distance range of
<code>300mm</code> to <code>5000mm</code> (<code>5m</code>). Measurements happen 6 times per second and are
readable via an analog, pulse width or serial output. The easiest implementation
is done by using <a href=https://www.arduino.cc/en/Reference/SoftwareSerialConstructor>Arduinos <code>softwareserial</code></a> and read the
distance values as chars. A full data sheet is available on the <a href=https://www.maxbotix.com/documents/HRXL-MaxSonar-WR_Datasheet.pdf>vendors
website</a>.</p>
<h3 id=rain-fall>Rain fall</h3>
<p>For rain fall two different rain gauges are used. While one is the de-facto
standard for scientific publications, the other allows measurements at a much
lower price. Both are usable by using a simple tip counter via an <code>GPIO</code>
interrupt and are simply connected to a <code>GND</code> PIN and whichever PIN was
configured with the interrupt.</p>
<h4 id=onset-hobo-rg-3>ONSET HOBO RG-3</h4>
<p>The <strong>HOBO Rain Gauge</strong> by <em>Onset Computer Corporation</em> offers a high quality
metal casing and is described as the default rain gauge for scientific
publications. With it&rsquo;s precision comes the price of <a href=https://www.onsetcomp.com/products/data-loggers/rg3/>around $400</a> which
may exceed the budget for some use cases.</p>
<blockquote>
<p>One tip means <code>0.254mm</code> or <code>0.1"</code> of rainfall.</p>
</blockquote>
<h4 id=misol-wh-sp-rg>Misol WH-SP-RG</h4>
<p>An alternative to is the <strong>WH-SP-RG</strong> by <em>Misol</em>. At the time of writing
(2021-09-21) the vendors website is not reachable, however other websites sell
the rain gauge for <a href=https://www.amazon.com/MISOL-Spare-weather-station-measure/dp/B00QDMBXUA/>around $20</a>.</p>
<blockquote>
<p>One tip means <code>0.3851mm</code> of rainfall.</p>
</blockquote>
<h3 id=soil-moisture>Soil Moisture</h3>
<p>For soil moisture the <strong>VH400</strong> by <em>Vegetronix, Inc</em> is supported. The sensor
that is connected to an <code>ADC</code> (<em>Analog Digital Converter</em>) PIN and the measured
resistance describes the <em>volumetric water content</em> by using a <a href=https://vegetronix.com/Products/VH400/VH400-Piecewise-Curve.phtml>piecewise
curve</a> provided by the vendor. The curve is implemented in the <a href=#sensor-node>provided
mini library</a>. The sensor costs <a href=https://vegetronix.com/Products/VH400/>around $40</a>.</p>
<h3 id=temperature>Temperature</h3>
<p>For waterproof temperature measuring a <strong>DS18B20</strong> sold by <em>Adafruit Industries,
LLC</em> is used. Adafruit ships their own libraries so minimal integration needs to
be coded. The sensor uses three wires which can be directly connected to the
<a href=#pcb>custom PCB</a>. The sensor costs <a href=https://www.adafruit.com/product/381>around $10</a> on
the Adafruit website.</p>
<h1 id=conclusion>Conclusion</h1>
<p>This project started initially with the evaluation of pure LoRa frequency
modulation using the Arduino library <a href=https://github.com/sandeepmistry/arduino-LoRa><code>arduino-LoRa</code></a>. While the tests
worked fine encryption, authentication as well as link optimization needed
manual solutions. Instead of pursuing the pure LoRa approach the switch to
LoRaWAN solved all these and even allowed easily redundant base station setups
plus roaming (e.g. for buoy setups).</p>
<p>Sensor nodes with the custom PCB board and low-cost <em>Heltec Dev Boards</em> were
tested for multiple month in the wild and delivered stable measurements. Due to
the modular code different combinations of sensors were easy to setup and new
sensors added within hours. While writing code for the <a href=https://www.davisinstruments.com/products/anemometer-for-vantage-pro2-vantage-pro>Davis Anemometer</a>
(wind direction and speed) is tested and may be fully supported in later
versions of the code.</p>
<p>During the time working on this projects multiple researcher at the <em>University
of Hawaii, Manoa</em> (UH) mentioned their interest in low-cost remote setups, using
all kinds of sensors which all would be compatible with the Arduino framework.
At the same time the <a href=https://www.hawaii.edu/its/>Information Technology Services</a> of <em>UH</em> collaborated
on improving the coverage of <em>Oahu</em> by deploying multiple high-performance base
stations around Honolulu.</p>
<p>While this project could be considered successful as in creating a <em>drop-in</em>
replacement for an existing setup and being at the extendible by other, no
<em>production</em> deployment is currently running. Due to the COVID-19 pandemic the
in-person collaboration with other scientists was lower than hoped for,
resulting in a lower variety of real setups around <em>Oahu</em>. Future work and
efforts are needed to establish LoRaWAN as the <em>goto</em> solution for wireless
metric transportation.</p>
<h1 id=outlook>Outlook</h1>
<p>Parts of the code should be refactored to allow PIN settings of sensors via the
<code>provision_node.py</code> script rather than the <code>config.h</code> file. This would allow a
single image for all sensors and thereby requiring only Python by the scientists
deploying sensors (in contrast to the current need of
<a href=#platformio>Platformio</a>).</p>
<p>Also the assembling of a LoRaWAN tracker should be fully documented. The tracker
allows interval or manual tracking of LoRaWAN coverage and can thereby be used
by scientists for evaluation of sensor node sites. Before a deployment the
tracking device would be taken in-field to verify sufficient coverage of
LoRaWAN.</p>
<p>Lastly a custom development board was designed to use the <em>CubeCell Module Plus</em>
instead of the development boards, which contain unnecessary parts (like LEDs
and buttons) which would not be used in production setups. The custom board is
in early development and not yet fully functional.</p>
<p><img src=img/pcb_custom_module.png alt="Custom PCB Module"></p>
<h1 id=code>Code</h1>
<p>Code used within this project. It could be used as a base and inspiration for
similar projects. The section consists of a <em>utility</em> section containing Python
code for monitoring and deployment and <em>sensor node</em>, <code>C</code> code which runs on
nodes.</p>
<h2 id=utility>Utility</h2>
<p>Monitoring and deployment code written in Python.</p>
<h3 id=mqtt2jsonpy><code>mqtt2json.py</code></h3>
<div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#60a0b0;font-style:italic># Copyright Paul Spooren &lt;mail@aparcar.org&gt;</span>
<span style=color:#60a0b0;font-style:italic>#</span>
<span style=color:#60a0b0;font-style:italic># SPDX-License-Identifier: GPL-2.0-or-later</span>

<span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>json</span>
<span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>os</span> <span style=color:#007020;font-weight:700>import</span> getenv
<span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>sys</span> <span style=color:#007020;font-weight:700>import</span> stderr

<span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>paho.mqtt.client</span> <span style=color:#007020;font-weight:700>as</span> <span style=color:#0e84b5;font-weight:700>mqtt</span>

broker <span style=color:#666>=</span> getenv(<span style=color:#4070a0>&#34;MQTT_URL&#34;</span>, <span style=color:#4070a0>&#34;nam1.cloud.thethings.network&#34;</span>)
username <span style=color:#666>=</span> getenv(<span style=color:#4070a0>&#34;MQTT_USER&#34;</span>, <span style=color:#4070a0>&#34;meshlab@ttn&#34;</span>)
token <span style=color:#666>=</span> getenv(<span style=color:#4070a0>&#34;MQTT_TOKEN&#34;</span>)

<span style=color:#007020;font-weight:700>assert</span> token <span style=color:#007020;font-weight:700>is</span> <span style=color:#007020;font-weight:700>not</span> <span style=color:#007020;font-weight:700>None</span>, <span style=color:#4070a0>&#34;Please set MQTT_TOKEN env variable&#34;</span>


<span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>on_connect</span>(mqttc, obj, flags, rc):
    <span style=color:#007020>print</span>(<span style=color:#4070a0>&#34;rc: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>str</span>(rc), file<span style=color:#666>=</span>stderr)


<span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>on_message</span>(mqttc, obj, msg):
    decoded_message <span style=color:#666>=</span> json<span style=color:#666>.</span>loads(msg<span style=color:#666>.</span>payload<span style=color:#666>.</span>decode(<span style=color:#4070a0>&#34;utf-8&#34;</span>))

    <span style=color:#60a0b0;font-style:italic># use this as node_id to have the unique dev_eui</span>
    <span style=color:#60a0b0;font-style:italic>#node_id = decoded_message[&#34;end_device_ids&#34;][&#34;dev_eui&#34;]</span>

    <span style=color:#60a0b0;font-style:italic># use this as node_id to have the human readable identifier</span>
    node_id <span style=color:#666>=</span> msg<span style=color:#666>.</span>topic<span style=color:#666>.</span>split(<span style=color:#4070a0>&#34;/&#34;</span>)[<span style=color:#666>-</span><span style=color:#40a070>2</span>]

    <span style=color:#007020;font-weight:700>if</span> <span style=color:#4070a0>&#34;decoded_payload&#34;</span> <span style=color:#007020;font-weight:700>in</span> decoded_message<span style=color:#666>.</span>get(<span style=color:#4070a0>&#34;uplink_message&#34;</span>, {}):
        <span style=color:#007020>print</span>(
            json<span style=color:#666>.</span>dumps(
                {
                    <span style=color:#4070a0>&#34;from&#34;</span>: node_id,
                    <span style=color:#4070a0>&#34;p&#34;</span>: decoded_message[<span style=color:#4070a0>&#34;uplink_message&#34;</span>][<span style=color:#4070a0>&#34;decoded_payload&#34;</span>],
                }
            )
        )


<span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>on_publish</span>(mqttc, obj, mid):
    <span style=color:#007020>print</span>(<span style=color:#4070a0>&#34;mid: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>str</span>(mid), file<span style=color:#666>=</span>stderr)


<span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>on_subscribe</span>(mqttc, obj, mid, granted_qos):
    <span style=color:#007020>print</span>(<span style=color:#4070a0>&#34;Subscribed: &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>str</span>(mid) <span style=color:#666>+</span> <span style=color:#4070a0>&#34; &#34;</span> <span style=color:#666>+</span> <span style=color:#007020>str</span>(granted_qos), file<span style=color:#666>=</span>stderr)


<span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>on_log</span>(mqttc, obj, level, string):
    <span style=color:#007020>print</span>(string)


mqttc <span style=color:#666>=</span> mqtt<span style=color:#666>.</span>Client()
mqttc<span style=color:#666>.</span>username_pw_set(username, token)
mqttc<span style=color:#666>.</span>on_message <span style=color:#666>=</span> on_message
mqttc<span style=color:#666>.</span>on_connect <span style=color:#666>=</span> on_connect
mqttc<span style=color:#666>.</span>on_publish <span style=color:#666>=</span> on_publish
mqttc<span style=color:#666>.</span>on_subscribe <span style=color:#666>=</span> on_subscribe
mqttc<span style=color:#666>.</span>tls_set_context()

<span style=color:#60a0b0;font-style:italic># Uncomment to enable debug messages</span>
<span style=color:#60a0b0;font-style:italic># mqttc.on_log = on_log</span>

mqttc<span style=color:#666>.</span>connect(broker, <span style=color:#40a070>8883</span>, <span style=color:#40a070>60</span>)
mqttc<span style=color:#666>.</span>subscribe(<span style=color:#4070a0>&#34;#&#34;</span>, <span style=color:#40a070>0</span>)

mqttc<span style=color:#666>.</span>loop_forever()
</code></pre></div><h3 id=provision_nodepy><code>provision_node.py</code></h3>
<div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#60a0b0;font-style:italic># Copyright Paul Spooren &lt;mail@aparcar.org&gt;</span>
<span style=color:#60a0b0;font-style:italic>#</span>
<span style=color:#60a0b0;font-style:italic># SPDX-License-Identifier: GPL-2.0-or-later</span>

<span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>serial</span>
<span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>sys</span>
<span style=color:#007020;font-weight:700>import</span> <span style=color:#0e84b5;font-weight:700>yaml</span>
<span style=color:#007020;font-weight:700>from</span> <span style=color:#0e84b5;font-weight:700>pathlib</span> <span style=color:#007020;font-weight:700>import</span> Path

<span style=color:#007020>print</span>(<span style=color:#4070a0>f</span><span style=color:#4070a0>&#34;</span><span style=color:#70a0d0;font-style:italic>{</span>sys<span style=color:#666>.</span>argv[<span style=color:#40a070>0</span>]<span style=color:#70a0d0;font-style:italic>}</span><span style=color:#4070a0> [node_name] [serial_port] [bitrage]&#34;</span>)
<span style=color:#007020;font-weight:700>if</span> <span style=color:#007020>len</span>(sys<span style=color:#666>.</span>argv) <span style=color:#666>==</span> <span style=color:#40a070>2</span>:
    node_name <span style=color:#666>=</span> sys<span style=color:#666>.</span>argv[<span style=color:#40a070>1</span>]
<span style=color:#007020;font-weight:700>else</span>:
    node_name <span style=color:#666>=</span> <span style=color:#4070a0>&#34;develop&#34;</span>

<span style=color:#007020;font-weight:700>if</span> <span style=color:#007020>len</span>(sys<span style=color:#666>.</span>argv) <span style=color:#666>==</span> <span style=color:#40a070>3</span>:
    node_serial <span style=color:#666>=</span> sys<span style=color:#666>.</span>argv[<span style=color:#40a070>2</span>]
<span style=color:#007020;font-weight:700>else</span>:
    node_serial <span style=color:#666>=</span> <span style=color:#4070a0>&#34;/dev/ttyUSB0&#34;</span>

<span style=color:#007020;font-weight:700>if</span> <span style=color:#007020>len</span>(sys<span style=color:#666>.</span>argv) <span style=color:#666>==</span> <span style=color:#40a070>4</span>:
    node_bitrate <span style=color:#666>=</span> <span style=color:#007020>int</span>(sys<span style=color:#666>.</span>argv[<span style=color:#40a070>3</span>])
<span style=color:#007020;font-weight:700>else</span>:
    node_bitrate <span style=color:#666>=</span> <span style=color:#40a070>115200</span>

<span style=color:#007020>print</span>(<span style=color:#4070a0>f</span><span style=color:#4070a0>&#34;Provisioning </span><span style=color:#70a0d0;font-style:italic>{</span>node_name<span style=color:#70a0d0;font-style:italic>}</span><span style=color:#4070a0> at </span><span style=color:#70a0d0;font-style:italic>{</span>node_serial<span style=color:#70a0d0;font-style:italic>}</span><span style=color:#4070a0>&#34;</span>)

<span style=color:#007020;font-weight:700>if</span> <span style=color:#007020;font-weight:700>not</span> Path(node_serial)<span style=color:#666>.</span>is_char_device():
    <span style=color:#007020>print</span>(<span style=color:#4070a0>f</span><span style=color:#4070a0>&#34;Missing serial connection for node at </span><span style=color:#70a0d0;font-style:italic>{</span>node_serial<span style=color:#70a0d0;font-style:italic>}</span><span style=color:#4070a0>&#34;</span>)
    quit(<span style=color:#40a070>1</span>)

config_path <span style=color:#666>=</span> Path(<span style=color:#4070a0>f</span><span style=color:#4070a0>&#34;./nodes/</span><span style=color:#70a0d0;font-style:italic>{</span>node_name<span style=color:#70a0d0;font-style:italic>}</span><span style=color:#4070a0>.yml&#34;</span>)

<span style=color:#007020;font-weight:700>if</span> <span style=color:#007020;font-weight:700>not</span> config_path<span style=color:#666>.</span>is_file():
    <span style=color:#007020>print</span>(<span style=color:#4070a0>f</span><span style=color:#4070a0>&#34;Missing node config at nodes/</span><span style=color:#70a0d0;font-style:italic>{</span>node_name<span style=color:#70a0d0;font-style:italic>}</span><span style=color:#4070a0>.yml&#34;</span>)
    quit(<span style=color:#40a070>1</span>)

config <span style=color:#666>=</span> yaml<span style=color:#666>.</span>safe_load(config_path<span style=color:#666>.</span>read_text())


<span style=color:#007020;font-weight:700>def</span> <span style=color:#06287e>AT_command</span>(key, value):
    serial_connection<span style=color:#666>.</span>write(<span style=color:#007020>bytes</span>(<span style=color:#4070a0>&#34;</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, <span style=color:#4070a0>&#34;ascii&#34;</span>))
    serial_connection<span style=color:#666>.</span>readline()

    at_command <span style=color:#666>=</span> <span style=color:#4070a0>f</span><span style=color:#4070a0>&#34;AT+</span><span style=color:#70a0d0;font-style:italic>{</span>key<span style=color:#70a0d0;font-style:italic>}</span><span style=color:#4070a0>=</span><span style=color:#70a0d0;font-style:italic>{</span>value<span style=color:#70a0d0;font-style:italic>}</span><span style=color:#4070a0>&#34;</span>
    serial_connection<span style=color:#666>.</span>write(<span style=color:#007020>bytes</span>(at_command, <span style=color:#4070a0>&#34;ascii&#34;</span>))
    <span style=color:#007020>print</span>(at_command)
    status <span style=color:#666>=</span> serial_connection<span style=color:#666>.</span>readline()<span style=color:#666>.</span>decode(<span style=color:#4070a0>&#34;utf-8&#34;</span>)
    <span style=color:#007020>print</span>(<span style=color:#4070a0>f</span><span style=color:#4070a0>&#34;STATUS: </span><span style=color:#70a0d0;font-style:italic>{</span>status<span style=color:#70a0d0;font-style:italic>}</span><span style=color:#4070a0>&#34;</span>)
    <span style=color:#007020;font-weight:700>if</span> <span style=color:#007020;font-weight:700>not</span> status<span style=color:#666>.</span>startswith(<span style=color:#4070a0>&#34;+OK&#34;</span>):
        <span style=color:#007020>print</span>(status)
        sys<span style=color:#666>.</span>exit(<span style=color:#40a070>1</span>)

    <span style=color:#007020;font-weight:700>return</span> serial_connection<span style=color:#666>.</span>readline()<span style=color:#666>.</span>decode(<span style=color:#4070a0>&#34;utf-8&#34;</span>)


serial_connection <span style=color:#666>=</span> serial<span style=color:#666>.</span>Serial(node_serial, node_bitrate, timeout<span style=color:#666>=</span><span style=color:#40a070>1</span>)

<span style=color:#007020;font-weight:700>for</span> key, value <span style=color:#007020;font-weight:700>in</span> config[<span style=color:#4070a0>&#34;at_commands&#34;</span>]<span style=color:#666>.</span>items():
    <span style=color:#007020;font-weight:700>if</span> <span style=color:#007020;font-weight:700>not</span> value:
        value <span style=color:#666>=</span> <span style=color:#4070a0>&#34;0&#34;</span> <span style=color:#666>*</span> <span style=color:#40a070>16</span>
    AT_command(key, <span style=color:#007020>str</span>(value))

<span style=color:#60a0b0;font-style:italic># restart node</span>
AT_command(<span style=color:#4070a0>&#34;RESET&#34;</span>, <span style=color:#40a070>1</span>)

serial_connection<span style=color:#666>.</span>close()
</code></pre></div><h2 id=sensor-node-1>Sensor Node</h2>
<p>Code running on sensor node written in <code>C</code>.</p>
<h3 id=maincpp><code>main.cpp</code></h3>
<div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#60a0b0;font-style:italic>// Copyright Paul Spooren &lt;mail@aparcar.org&gt;
</span><span style=color:#60a0b0;font-style:italic>//
</span><span style=color:#60a0b0;font-style:italic>// SPDX-License-Identifier: GPL-2.0-or-later
</span><span style=color:#60a0b0;font-style:italic></span>
<span style=color:#007020>#include</span> <span style=color:#007020>&#34;Arduino.h&#34;.</span><span style=color:#007020>
</span><span style=color:#007020>#include</span> <span style=color:#007020>&#34;LoRaWan_APP.h&#34;</span><span style=color:#007020>
</span><span style=color:#007020>#include</span> <span style=color:#007020>&#34;MB7389.h&#34;</span><span style=color:#007020>
</span><span style=color:#007020>#include</span> <span style=color:#007020>&#34;VH400.h&#34;</span><span style=color:#007020>
</span><span style=color:#007020>#include</span> <span style=color:#007020>&#34;config.h&#34;</span><span style=color:#007020>
</span><span style=color:#007020>#include</span> <span style=color:#007020>&lt;CayenneLPP.h&gt;</span><span style=color:#007020>
</span><span style=color:#007020>#include</span> <span style=color:#007020>&lt;DallasTemperature.h&gt;</span><span style=color:#007020>
</span><span style=color:#007020>#include</span> <span style=color:#007020>&lt;OneWire.h&gt;</span><span style=color:#007020>
</span><span style=color:#007020>#include</span> <span style=color:#007020>&lt;SPI.h&gt;</span><span style=color:#007020>
</span><span style=color:#007020>#include</span> <span style=color:#007020>&lt;Wire.h&gt;</span><span style=color:#007020>
</span><span style=color:#007020>#include</span> <span style=color:#007020>&lt;softSerial.h&gt;</span><span style=color:#007020>
</span><span style=color:#007020></span>
<span style=color:#007020>#define LoraWan_RGB 0
</span><span style=color:#007020></span>
<span style=color:#60a0b0;font-style:italic>// This section allows to store data on the device. Specifically this allows to
</span><span style=color:#60a0b0;font-style:italic>// store the rain gauge *mm per tip* value.
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020>#define ROW 0
</span><span style=color:#007020>#define ROW_OFFSET 100
</span><span style=color:#007020></span><span style=color:#60a0b0;font-style:italic>// CY_FLASH_SIZEOF_ROW is 256 , CY_SFLASH_USERBASE is 0x0ffff400
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020>#define addr_rain_gauge                                                        \
</span><span style=color:#007020>  CY_SFLASH_USERBASE + CY_FLASH_SIZEOF_ROW *ROW + ROW_OFFSET
</span><span style=color:#007020></span>
CayenneLPP <span style=color:#06287e>lpp</span>(LORAWAN_APP_DATA_MAX_SIZE);

<span style=color:#60a0b0;font-style:italic>// Set to BATTERY_SEND_INTERVAL to send on start
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#902000>uint32_t</span> battery_send_counter <span style=color:#666>=</span> BATTERY_SEND_INTERVAL;

<span style=color:#60a0b0;font-style:italic>// Run cycle every minute
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#902000>uint32_t</span> appTxDutyCycle <span style=color:#666>=</span> <span style=color:#40a070>60000</span>;

<span style=color:#60a0b0;font-style:italic>// Send messages on specific port. For this application all data is transmitted
</span><span style=color:#60a0b0;font-style:italic>// on port 2. The port is used to distinguish between packet types, however
</span><span style=color:#60a0b0;font-style:italic>// since this implementation uses CayenneLPP which is parsed by the backend, all
</span><span style=color:#60a0b0;font-style:italic>// data can be sent over the same port.
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#902000>uint8_t</span> appPort <span style=color:#666>=</span> <span style=color:#40a070>2</span>;

<span style=color:#60a0b0;font-style:italic>// Initialize variables required for rain gauge use
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020>#ifdef RAIN_GAUGE_PIN
</span><span style=color:#007020></span><span style=color:#60a0b0;font-style:italic>// union to store directly on EEPROM
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>union</span> {
  <span style=color:#902000>float</span> number;
  <span style=color:#902000>uint8_t</span> bytes[<span style=color:#40a070>4</span>];
} mm_per_tip;

<span style=color:#60a0b0;font-style:italic>// The tip counter and mm, must reset after each cycle
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>static</span> <span style=color:#007020;font-weight:700>volatile</span> <span style=color:#902000>uint8_t</span> tips <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
<span style=color:#007020;font-weight:700>static</span> <span style=color:#902000>unsigned</span> <span style=color:#902000>long</span> last_switch <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
<span style=color:#007020>#endif
</span><span style=color:#007020></span>
<span style=color:#007020>#ifdef DAVIS_SPEED_PIN
</span><span style=color:#007020></span><span style=color:#007020;font-weight:700>static</span> <span style=color:#902000>uint32_t</span> rotations <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
<span style=color:#007020;font-weight:700>static</span> <span style=color:#902000>unsigned</span> <span style=color:#902000>long</span> davis_speed_debounce <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
<span style=color:#902000>uint32_t</span> davis_speed_send_counter <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
<span style=color:#007020>#endif
</span><span style=color:#007020></span>
<span style=color:#007020>#ifdef DAVIS_DIRECTION_PIN
</span><span style=color:#007020></span><span style=color:#902000>uint32_t</span> davis_direction_send_counter <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
<span style=color:#902000>uint32_t</span> davis_direction_total <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
<span style=color:#007020>#endif
</span><span style=color:#007020></span>
<span style=color:#60a0b0;font-style:italic>// Initialize variables required for OneWire temperature
</span><span style=color:#60a0b0;font-style:italic>//
</span><span style=color:#60a0b0;font-style:italic>// The current setup only supports a single connected sensor while it is easily
</span><span style=color:#60a0b0;font-style:italic>// possible to monitor multiple OneWire sensors at the same time.
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020>#ifdef ONEWIRE_PIN
</span><span style=color:#007020></span>OneWire <span style=color:#06287e>onewire</span>(ONEWIRE_PIN);
DallasTemperature <span style=color:#06287e>onewire_sensor</span>(<span style=color:#666>&amp;</span>onewire);
<span style=color:#902000>uint32_t</span> onewire_send_counter <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
<span style=color:#902000>float</span> onewire_total <span style=color:#666>=</span> <span style=color:#40a070>0.0</span>;
<span style=color:#007020>#endif
</span><span style=color:#007020></span>
<span style=color:#60a0b0;font-style:italic>// Initialize variables required for VH400 moisture sensor
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020>#ifdef VH400_PIN
</span><span style=color:#007020></span><span style=color:#902000>uint32_t</span> vh400_send_counter <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
<span style=color:#902000>float</span> vh400_total <span style=color:#666>=</span> <span style=color:#40a070>0.0</span>;
<span style=color:#007020>#endif
</span><span style=color:#007020></span>
<span style=color:#60a0b0;font-style:italic>// Initialize variables for MB7389 ultrasonic distance sensor
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020>#ifdef SONIC_RX_PIN
</span><span style=color:#007020></span><span style=color:#902000>uint32_t</span> sonic_send_counter <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
<span style=color:#902000>uint32_t</span> sonic_total <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
softSerial <span style=color:#06287e>sonicSerial</span>(<span style=color:#40a070>0</span>, SONIC_RX_PIN);
<span style=color:#007020>#endif
</span><span style=color:#007020></span>
<span style=color:#60a0b0;font-style:italic>// Prepare the outgoing packet stored in CayenneLPP format
</span><span style=color:#60a0b0;font-style:italic>//
</span><span style=color:#60a0b0;font-style:italic>// The packet might be empty and sending is omitted for that cycle.
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020;font-weight:700>static</span> <span style=color:#902000>void</span> <span style=color:#06287e>prepareTxFrame</span>() {
  lpp.reset();

  <span style=color:#60a0b0;font-style:italic>// Send battery status only every &#34;BATTERY_SEND_INTERVAL&#34; minutes
</span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#007020;font-weight:700>if</span> (battery_send_counter <span style=color:#666>&gt;=</span> BATTERY_SEND_INTERVAL) {
    Serial.printf(<span style=color:#4070a0>&#34;[%i/%i] Add battery volt</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, battery_send_counter,
                  BATTERY_SEND_INTERVAL);

    <span style=color:#60a0b0;font-style:italic>// Battery voltage is stored as voltage with ID 1
</span><span style=color:#60a0b0;font-style:italic></span>    lpp.addVoltage(<span style=color:#40a070>1</span>, getBatteryVoltage() <span style=color:#666>/</span> <span style=color:#40a070>1000.0</span>);

    <span style=color:#60a0b0;font-style:italic>// Running version is stored as digital output with ID 1
</span><span style=color:#60a0b0;font-style:italic></span>    lpp.addDigitalOutput(<span style=color:#40a070>1</span>, VERSION);

    <span style=color:#60a0b0;font-style:italic>// Reset counter
</span><span style=color:#60a0b0;font-style:italic></span>    battery_send_counter <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
  } <span style=color:#007020;font-weight:700>else</span> {
    Serial.printf(<span style=color:#4070a0>&#34;[%i/%i] Skip battery volt</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, battery_send_counter,
                  BATTERY_SEND_INTERVAL);
    battery_send_counter<span style=color:#666>++</span>;
  }

<span style=color:#007020>#ifdef SONIC_RX_PIN
</span><span style=color:#007020></span>  sonic_total <span style=color:#666>+=</span> get_sonic_distance(sonicSerial, <span style=color:#40a070>60</span>);
  sonic_send_counter<span style=color:#666>++</span>;
  <span style=color:#007020;font-weight:700>if</span> (sonic_send_counter <span style=color:#666>==</span> SONIC_SEND_INTERVAL) {
    Serial.printf(<span style=color:#4070a0>&#34;[%i/%i] Add sonic</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, sonic_send_counter,
                  SONIC_SEND_INTERVAL);

    <span style=color:#60a0b0;font-style:italic>// Sea level is stored as distance with ID 1
</span><span style=color:#60a0b0;font-style:italic></span>    lpp.addDistance(<span style=color:#40a070>1</span>, ((<span style=color:#902000>float</span>)sonic_total <span style=color:#666>/</span> sonic_send_counter) <span style=color:#666>/</span> <span style=color:#40a070>100.0</span>);

    <span style=color:#60a0b0;font-style:italic>// Reset counters
</span><span style=color:#60a0b0;font-style:italic></span>    sonic_send_counter <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
    sonic_total <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
  } <span style=color:#007020;font-weight:700>else</span> {
    Serial.printf(<span style=color:#4070a0>&#34;[%i/%i] Skip sonic</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, sonic_send_counter,
                  SONIC_SEND_INTERVAL);
  }
<span style=color:#007020>#endif
</span><span style=color:#007020></span>
<span style=color:#007020>#ifdef RAIN_GAUGE_PIN
</span><span style=color:#007020></span>  <span style=color:#007020;font-weight:700>if</span> (tips <span style=color:#666>&gt;</span> <span style=color:#40a070>0</span>) {
    Serial.printf(<span style=color:#4070a0>&#34;Tips = %i</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, tips);

    <span style=color:#60a0b0;font-style:italic>// Rain fall is stored as analog with ID 1
</span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#60a0b0;font-style:italic>// The CayenneLPP specification do not support rain fall directly
</span><span style=color:#60a0b0;font-style:italic></span>    lpp.addAnalogInput(<span style=color:#40a070>1</span>, mm_per_tip.number <span style=color:#666>*</span> tips);

    <span style=color:#60a0b0;font-style:italic>// Reset counter
</span><span style=color:#60a0b0;font-style:italic></span>    tips <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
  } <span style=color:#007020;font-weight:700>else</span> {
    Serial.printf(<span style=color:#4070a0>&#34;Skip rain gauge</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>);
  }
<span style=color:#007020>#endif
</span><span style=color:#007020></span>
<span style=color:#007020>#ifdef DAVIS_SPEED_PIN
</span><span style=color:#007020></span>  davis_speed_send_counter<span style=color:#666>++</span>;
  <span style=color:#007020;font-weight:700>if</span> (davis_speed_send_counter <span style=color:#666>&gt;=</span> DAVIS_SPEED_SEND_INTERVAL) {
    Serial.printf(<span style=color:#4070a0>&#34;[%i/%i] Add Davis speed</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, davis_speed_send_counter,
                  DAVIS_SPEED_SEND_INTERVAL);

    <span style=color:#60a0b0;font-style:italic>// Moisture is stored as analog with ID 2
</span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#60a0b0;font-style:italic>// The CayenneLPP specification do not support moisture directly
</span><span style=color:#60a0b0;font-style:italic></span>    lpp.addFrequency(<span style=color:#40a070>1</span>, rotations <span style=color:#666>/</span> (<span style=color:#40a070>60</span> <span style=color:#666>*</span> davis_speed_send_counter));

    <span style=color:#60a0b0;font-style:italic>// Reset counters
</span><span style=color:#60a0b0;font-style:italic></span>    davis_speed_send_counter <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
    rotations <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
  } <span style=color:#007020;font-weight:700>else</span> {
    Serial.printf(<span style=color:#4070a0>&#34;[%i/%i] Skip Davis speed</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, davis_speed_send_counter,
                  DAVIS_SPEED_SEND_INTERVAL);
  }
<span style=color:#007020>#endif
</span><span style=color:#007020></span>
<span style=color:#007020>#ifdef DAVIS_DIRECTION_PIN
</span><span style=color:#007020></span>  davis_direction_total <span style=color:#666>+=</span> analogReadmV(DAVIS_DIRECTION_PIN);
  davis_direction_send_counter<span style=color:#666>++</span>;
  <span style=color:#007020;font-weight:700>if</span> (davis_direction_send_counter <span style=color:#666>&gt;=</span> DAVIS_DIRECTION_SEND_INTERVAL) {
    Serial.printf(<span style=color:#4070a0>&#34;[%i/%i] Add Davis direction</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, davis_direction_send_counter,
                  DAVIS_DIRECTION_SEND_INTERVAL);

    <span style=color:#60a0b0;font-style:italic>// Moisture is stored as analog with ID 2
</span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#60a0b0;font-style:italic>// The CayenneLPP specification do not support moisture directly
</span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#902000>int</span> direction <span style=color:#666>=</span>
        ((davis_direction_total <span style=color:#666>/</span> davis_direction_send_counter) <span style=color:#666>/</span> <span style=color:#40a070>2400</span>) <span style=color:#666>*</span> <span style=color:#40a070>360</span>;
    lpp.addDirection(<span style=color:#40a070>1</span>, direction);

    <span style=color:#60a0b0;font-style:italic>// Reset counters
</span><span style=color:#60a0b0;font-style:italic></span>    davis_direction_send_counter <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
    davis_direction_total <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
  } <span style=color:#007020;font-weight:700>else</span> {
    Serial.printf(<span style=color:#4070a0>&#34;[%i/%i] Skip davis_direction</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>,
                  davis_direction_send_counter, DAVIS_DIRECTION_SEND_INTERVAL);
  }
<span style=color:#007020>#endif
</span><span style=color:#007020></span>
<span style=color:#007020>#ifdef VH400_PIN
</span><span style=color:#007020></span>  vh400_total <span style=color:#666>+=</span> read_VH400(VH400_PIN);
  vh400_send_counter<span style=color:#666>++</span>;
  <span style=color:#007020;font-weight:700>if</span> (vh400_send_counter <span style=color:#666>&gt;=</span> VH400_SEND_INTERVAL) {
    Serial.printf(<span style=color:#4070a0>&#34;[%i/%i] Add VH400</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, vh400_send_counter,
                  VH400_SEND_INTERVAL);

    <span style=color:#60a0b0;font-style:italic>// Moisture is stored as analog with ID 2
</span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#60a0b0;font-style:italic>// The CayenneLPP specification do not support moisture directly
</span><span style=color:#60a0b0;font-style:italic></span>    lpp.addAnalogInput(<span style=color:#40a070>2</span>, vh400_total <span style=color:#666>/</span> vh400_send_counter);

    <span style=color:#60a0b0;font-style:italic>// Reset counters
</span><span style=color:#60a0b0;font-style:italic></span>    vh400_send_counter <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
    vh400_total <span style=color:#666>=</span> <span style=color:#40a070>0.0</span>;
  } <span style=color:#007020;font-weight:700>else</span> {
    Serial.printf(<span style=color:#4070a0>&#34;[%i/%i] Skip VH400</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, vh400_send_counter,
                  VH400_SEND_INTERVAL);
  }
<span style=color:#007020>#endif
</span><span style=color:#007020></span>
<span style=color:#007020>#ifdef ONEWIRE_PIN
</span><span style=color:#007020></span>  onewire_sensor.requestTemperatures();
  onewire_total <span style=color:#666>+=</span> onewire_sensor.getTempCByIndex(<span style=color:#40a070>0</span>);
  onewire_send_counter<span style=color:#666>++</span>;
  <span style=color:#007020;font-weight:700>if</span> (onewire_send_counter <span style=color:#666>&gt;=</span> ONEWIRE_SEND_INTERVAL) {
    Serial.printf(<span style=color:#4070a0>&#34;[%i/%i] Add OneWire</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, onewire_send_counter,
                  ONEWIRE_SEND_INTERVAL);

    <span style=color:#60a0b0;font-style:italic>// Temperature is stored as temperature with ID 1
</span><span style=color:#60a0b0;font-style:italic></span>    lpp.addTemperature(<span style=color:#40a070>1</span>, onewire_total <span style=color:#666>/</span> onewire_send_counter);

    <span style=color:#60a0b0;font-style:italic>// Reset counters
</span><span style=color:#60a0b0;font-style:italic></span>    onewire_send_counter <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
    onewire_total <span style=color:#666>=</span> <span style=color:#40a070>0.0</span>;
  } <span style=color:#007020;font-weight:700>else</span> {
    Serial.printf(<span style=color:#4070a0>&#34;[%i/%i] Skip OneWire</span><span style=color:#4070a0;font-weight:700>\n</span><span style=color:#4070a0>&#34;</span>, onewire_send_counter,
                  ONEWIRE_SEND_INTERVAL);
  }
<span style=color:#007020>#endif
</span><span style=color:#007020></span>
  <span style=color:#60a0b0;font-style:italic>// Copy CayenneLPP frame to appData, which will be send
</span><span style=color:#60a0b0;font-style:italic></span>  lpp.getBuffer(), appDataSize <span style=color:#666>=</span> lpp.getSize();
  memcpy(appData, lpp.getBuffer(), appDataSize);
}

<span style=color:#60a0b0;font-style:italic>// Custom commands to provision device
</span><span style=color:#60a0b0;font-style:italic>//
</span><span style=color:#60a0b0;font-style:italic>// At this point only the rain gauge command `mmPerTip` is supported, however it
</span><span style=color:#60a0b0;font-style:italic>// is easily possible to extend this to e.g. support height setting of the tide
</span><span style=color:#60a0b0;font-style:italic>// gauges or other user specific commands.
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#902000>bool</span> <span style=color:#06287e>checkUserAt</span>(<span style=color:#902000>char</span> <span style=color:#666>*</span>cmd, <span style=color:#902000>char</span> <span style=color:#666>*</span>content) {
<span style=color:#007020>#ifdef RAIN_GAUGE_PIN
</span><span style=color:#007020></span>  <span style=color:#60a0b0;font-style:italic>// This command is used to set the tipping bucket size
</span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#60a0b0;font-style:italic>// - HOBO RG3: 0.254mm/t
</span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#60a0b0;font-style:italic>// - Misol WH-SP-RG: 0.3851mm/t
</span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#007020;font-weight:700>if</span> (strcmp(cmd, <span style=color:#4070a0>&#34;mmPerTip&#34;</span>) <span style=color:#666>==</span> <span style=color:#40a070>0</span>) {
    <span style=color:#007020;font-weight:700>if</span> (atof(content) <span style=color:#666>!=</span> mm_per_tip.number) {
      mm_per_tip.number <span style=color:#666>=</span> atof(content);
      Serial.print(<span style=color:#4070a0>&#34;+OK Set mm per tip to &#34;</span>);
      Serial.print(mm_per_tip.number, <span style=color:#40a070>4</span>);
      Serial.println(<span style=color:#4070a0>&#34;mm&#34;</span>);
      Serial.println();
      FLASH_update(addr_rain_gauge, mm_per_tip.bytes, <span style=color:#007020;font-weight:700>sizeof</span>(mm_per_tip.bytes));
    } <span style=color:#007020;font-weight:700>else</span> {
      Serial.println(<span style=color:#4070a0>&#34;+OK Same mm per tip as before&#34;</span>);
    }
    <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020>true</span>;
  }
<span style=color:#007020>#endif
</span><span style=color:#007020></span>  <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020>false</span>;
}

<span style=color:#007020>#ifdef RAIN_GAUGE_PIN
</span><span style=color:#007020></span><span style=color:#60a0b0;font-style:italic>// Run on each interrupt aka tip of the tipping bucket
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#902000>void</span> <span style=color:#06287e>handler_rain_gauge</span>() {
  <span style=color:#007020;font-weight:700>if</span> ((millis() <span style=color:#666>-</span> last_switch) <span style=color:#666>&gt;</span> <span style=color:#40a070>15</span>) {
    tips<span style=color:#666>++</span>;
    last_switch <span style=color:#666>=</span> millis();
  }
}
<span style=color:#007020>#endif
</span><span style=color:#007020></span>
<span style=color:#007020>#ifdef DAVIS_SPEED_PIN
</span><span style=color:#007020></span><span style=color:#60a0b0;font-style:italic>// Run on each interrupt aka tip of the tipping bucket
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#902000>void</span> <span style=color:#06287e>handler_davis_speed</span>() {
  <span style=color:#007020;font-weight:700>if</span> ((millis() <span style=color:#666>-</span> davis_speed_debounce) <span style=color:#666>&gt;</span> <span style=color:#40a070>15</span>) {
    rotations<span style=color:#666>++</span>;
    davis_speed_debounce <span style=color:#666>=</span> millis();
  }
}
<span style=color:#007020>#endif
</span><span style=color:#007020></span>
<span style=color:#902000>int</span> <span style=color:#06287e>get_direction</span>(<span style=color:#902000>int</span> davis_voltage) { <span style=color:#007020;font-weight:700>return</span> (davis_voltage <span style=color:#666>/</span> <span style=color:#40a070>2400</span>) <span style=color:#666>*</span> <span style=color:#40a070>360</span>; }

<span style=color:#60a0b0;font-style:italic>// The Arduino setup() function run on every boot
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#902000>void</span> <span style=color:#06287e>setup</span>() {
  <span style=color:#60a0b0;font-style:italic>// Set baudrate to 115200
</span><span style=color:#60a0b0;font-style:italic></span>  Serial.begin(<span style=color:#40a070>115200</span>);
  Serial.println(<span style=color:#4070a0>&#34;So it begins...&#34;</span>);

<span style=color:#007020>#ifdef RAIN_GAUGE_PIN
</span><span style=color:#007020></span>  <span style=color:#60a0b0;font-style:italic>// Read mm/t from EEPROM
</span><span style=color:#60a0b0;font-style:italic></span>  Serial.println(<span style=color:#4070a0>&#34;Enable rain gauge sensor&#34;</span>);
  FLASH_read_at(addr_rain_gauge, mm_per_tip.bytes, <span style=color:#007020;font-weight:700>sizeof</span>(mm_per_tip.bytes));
  <span style=color:#007020;font-weight:700>if</span> (mm_per_tip.number <span style=color:#666>==</span> <span style=color:#40a070>0.0</span>) {
    mm_per_tip.number <span style=color:#666>=</span> DEFAULT_MM_PER_COUNT;
  }
  Serial.print(<span style=color:#4070a0>&#34;Current mm per tip is &#34;</span>);
  Serial.print(mm_per_tip.number, <span style=color:#40a070>4</span>);
  Serial.println(<span style=color:#4070a0>&#34;mm&#34;</span>);

  <span style=color:#60a0b0;font-style:italic>// Enable interrupt pin for tips
</span><span style=color:#60a0b0;font-style:italic></span>  PINMODE_INPUT_PULLUP(RAIN_GAUGE_PIN);
  attachInterrupt(RAIN_GAUGE_PIN, handler_rain_gauge, FALLING);
<span style=color:#007020>#endif
</span><span style=color:#007020></span>
<span style=color:#007020>#ifdef DAVIS_SPEED_PIN
</span><span style=color:#007020></span>  <span style=color:#60a0b0;font-style:italic>// Read mm/t from EEPROM
</span><span style=color:#60a0b0;font-style:italic></span>  Serial.println(<span style=color:#4070a0>&#34;Enable Davis speed sensor&#34;</span>);

  <span style=color:#60a0b0;font-style:italic>// Enable interrupt pin for tips
</span><span style=color:#60a0b0;font-style:italic></span>  PINMODE_INPUT_PULLUP(DAVIS_SPEED_PIN);
  attachInterrupt(DAVIS_SPEED_PIN, handler_davis_speed, FALLING);
<span style=color:#007020>#endif
</span><span style=color:#007020></span>
<span style=color:#007020>#ifdef ONEWIRE_PIN
</span><span style=color:#007020></span>  <span style=color:#60a0b0;font-style:italic>// Setup OneWire and print single test measurement
</span><span style=color:#60a0b0;font-style:italic></span>  Serial.println(<span style=color:#4070a0>&#34;Enable OneWire sensor&#34;</span>);
  onewire_sensor.begin();
  onewire_sensor.requestTemperatures();
  Serial.print(<span style=color:#4070a0>&#34;temperature = &#34;</span>);
  Serial.print(onewire_sensor.getTempCByIndex(<span style=color:#40a070>0</span>), <span style=color:#40a070>2</span>);
  Serial.println();
<span style=color:#007020>#endif
</span><span style=color:#007020></span>
  <span style=color:#60a0b0;font-style:italic>// Enable user input via Serial for AT commands
</span><span style=color:#60a0b0;font-style:italic></span>  enableAt();

<span style=color:#007020>#ifdef DAVIS_DIRECTION_PIN
</span><span style=color:#007020></span>  <span style=color:#60a0b0;font-style:italic>// Setup Davis direction sensor and print single test measurement
</span><span style=color:#60a0b0;font-style:italic></span>  Serial.println(<span style=color:#4070a0>&#34;Enable Davis direction sensor&#34;</span>);
  pinMode(DAVIS_DIRECTION_PIN, INPUT);
  Serial.print(<span style=color:#4070a0>&#34;direction = &#34;</span>);
  Serial.print(get_direction(analogReadmV(DAVIS_DIRECTION_PIN)));
  Serial.println();
<span style=color:#007020>#endif
</span><span style=color:#007020></span>
<span style=color:#007020>#ifdef VH400_PIN
</span><span style=color:#007020></span>  <span style=color:#60a0b0;font-style:italic>// Setup VH400 sensor and print single test measurement
</span><span style=color:#60a0b0;font-style:italic></span>  Serial.println(<span style=color:#4070a0>&#34;Enable VH400 sensor&#34;</span>);
  pinMode(VH400_PIN, INPUT);
  Serial.print(<span style=color:#4070a0>&#34;moisture = &#34;</span>);
  Serial.print(analogReadmV(VH400_PIN));
  <span style=color:#60a0b0;font-style:italic>// Serial.print(read_VH400(VH400_PIN), 2);
</span><span style=color:#60a0b0;font-style:italic></span>  Serial.println();
<span style=color:#007020>#endif
</span><span style=color:#007020></span>
<span style=color:#007020>#ifdef DAVIS_SPEED_PIN
</span><span style=color:#007020></span>
<span style=color:#007020>#endif
</span><span style=color:#007020></span>
<span style=color:#007020>#ifdef DAVIS_DIRECTION_PIN
</span><span style=color:#007020></span>
<span style=color:#007020>#endif
</span><span style=color:#007020></span>
<span style=color:#007020>#ifdef SONIC_RX_PIN
</span><span style=color:#007020></span>  <span style=color:#60a0b0;font-style:italic>// Print single test measurement
</span><span style=color:#60a0b0;font-style:italic></span>  Serial.println(<span style=color:#4070a0>&#34;Enable sonic sensor&#34;</span>);
  Serial.print(<span style=color:#4070a0>&#34;distance = &#34;</span>);
  Serial.print(get_sonic_distance(sonicSerial, <span style=color:#40a070>1</span>));
  Serial.println();
<span style=color:#007020>#endif
</span><span style=color:#007020></span>
  <span style=color:#60a0b0;font-style:italic>// Set Arduino into the initialization state
</span><span style=color:#60a0b0;font-style:italic></span>  deviceState <span style=color:#666>=</span> DEVICE_STATE_INIT;

  LoRaWAN.ifskipjoin();
}

<span style=color:#902000>void</span> <span style=color:#06287e>loop</span>() {
  <span style=color:#007020;font-weight:700>switch</span> (deviceState) {
  <span style=color:#007020;font-weight:700>case</span> <span style=color:#002070;font-weight:700>DEVICE_STATE_INIT</span>: {
    getDevParam();
    printDevParam();
    LoRaWAN.init(loraWanClass, loraWanRegion);
    deviceState <span style=color:#666>=</span> DEVICE_STATE_JOIN;
    <span style=color:#007020;font-weight:700>break</span>;
  }
  <span style=color:#007020;font-weight:700>case</span> <span style=color:#002070;font-weight:700>DEVICE_STATE_JOIN</span>: {
    LoRaWAN.join();
    <span style=color:#007020;font-weight:700>break</span>;
  }
  <span style=color:#007020;font-weight:700>case</span> <span style=color:#002070;font-weight:700>DEVICE_STATE_SEND</span>: {
    prepareTxFrame();

    <span style=color:#60a0b0;font-style:italic>// Do not send empty packages
</span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#007020;font-weight:700>if</span> (appDataSize <span style=color:#666>&gt;</span> <span style=color:#40a070>0</span>) {
      LoRaWAN.send();
    } <span style=color:#007020;font-weight:700>else</span> {
      Serial.println(<span style=color:#4070a0>&#34;Package is empty, don&#39;t send anything&#34;</span>);
    }
    deviceState <span style=color:#666>=</span> DEVICE_STATE_CYCLE;
    <span style=color:#007020;font-weight:700>break</span>;
  }
  <span style=color:#007020;font-weight:700>case</span> <span style=color:#002070;font-weight:700>DEVICE_STATE_CYCLE</span>: {
<span style=color:#60a0b0;font-style:italic>// If sonic sensor is enabled it will measure 60 times a minute and return the
</span><span style=color:#60a0b0;font-style:italic>// average. This way waves don&#39;t influence tide estimations as much. Since a
</span><span style=color:#60a0b0;font-style:italic>// measurement is required every second the duty cycle is skipped and instead
</span><span style=color:#60a0b0;font-style:italic>// the get_sonic_distance function runs, which blocks for 60 seconds.
</span><span style=color:#60a0b0;font-style:italic>// If no sonic sensor is attached, use the
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020>#ifdef SONIC_RX_PIN
</span><span style=color:#007020></span>    LoRaWAN.sleep();
    <span style=color:#60a0b0;font-style:italic>// Add random delay so sensors don&#39;t repetitively send at the same time.
</span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#60a0b0;font-style:italic>// This is done do avoid a situation where many sensors start at the same
</span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#60a0b0;font-style:italic>// time and collectively overload the gateway every 60 seconds.
</span><span style=color:#60a0b0;font-style:italic></span>    delay(randr(<span style=color:#40a070>0</span>, APP_TX_DUTYCYCLE_RND));
    deviceState <span style=color:#666>=</span> DEVICE_STATE_SEND;
<span style=color:#007020>#else
</span><span style=color:#007020></span>    <span style=color:#60a0b0;font-style:italic>// Same random delay is applied here.
</span><span style=color:#60a0b0;font-style:italic></span>    txDutyCycleTime <span style=color:#666>=</span> appTxDutyCycle <span style=color:#666>+</span> randr(<span style=color:#40a070>0</span>, APP_TX_DUTYCYCLE_RND);
    LoRaWAN.cycle(txDutyCycleTime);
    deviceState <span style=color:#666>=</span> DEVICE_STATE_SLEEP;
<span style=color:#007020>#endif
</span><span style=color:#007020></span>    <span style=color:#007020;font-weight:700>break</span>;
  }
  <span style=color:#007020;font-weight:700>case</span> <span style=color:#002070;font-weight:700>DEVICE_STATE_SLEEP</span>: {
    LoRaWAN.sleep();
    <span style=color:#007020;font-weight:700>break</span>;
  }
  <span style=color:#007020;font-weight:700>default</span><span style=color:#666>:</span> {
    deviceState <span style=color:#666>=</span> DEVICE_STATE_INIT;
    <span style=color:#007020;font-weight:700>break</span>;
  }
  }
}
</code></pre></div><h3 id=configh><code>config.h</code></h3>
<div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#60a0b0;font-style:italic>/*
</span><span style=color:#60a0b0;font-style:italic> * Describes the currently running version. This value is transmitted next to
</span><span style=color:#60a0b0;font-style:italic> * the battery voltage and helps to keep track what software version is running
</span><span style=color:#60a0b0;font-style:italic> * on nodes. It should be increased whenever a significant change to logic
</span><span style=color:#60a0b0;font-style:italic> * happens which may change the behaviour of a running device.
</span><span style=color:#60a0b0;font-style:italic> */</span>
<span style=color:#007020>#define VERSION 4
</span><span style=color:#007020></span>
<span style=color:#60a0b0;font-style:italic>// How often to send battery voltage (and version) in minutes
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020>#define BATTERY_SEND_INTERVAL 360 </span><span style=color:#60a0b0;font-style:italic>// 6 hours
</span><span style=color:#60a0b0;font-style:italic>// How often to send OneWire temperature in minutes
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020>#define ONEWIRE_SEND_INTERVAL 30
</span><span style=color:#007020></span><span style=color:#60a0b0;font-style:italic>// How often to send MB7389 sonic distance in minutes
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020>#define SONIC_SEND_INTERVAL 10
</span><span style=color:#007020></span><span style=color:#60a0b0;font-style:italic>// How often to send VH400 moisture in minutes
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020>#define VH400_SEND_INTERVAL 3
</span><span style=color:#007020></span><span style=color:#60a0b0;font-style:italic>// How often to send Davis wind speed in minutes
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020>#define DAVIS_SPEED_SEND_INTERVAL 2
</span><span style=color:#007020></span><span style=color:#60a0b0;font-style:italic>// How often to send Davis wind direction in minutes
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020>#define DAVIS_DIRECTION_SEND_INTERVAL 2
</span><span style=color:#007020></span>
<span style=color:#60a0b0;font-style:italic>/*
</span><span style=color:#60a0b0;font-style:italic> * Setting PINs to devices will enable them within the code. The default values
</span><span style=color:#60a0b0;font-style:italic> * presented here work fine with Heltec CubeCell boards, allowing to attach all
</span><span style=color:#60a0b0;font-style:italic> * sensor at once. However it is also possible to remove any PIN definition and
</span><span style=color:#60a0b0;font-style:italic> * thereby disable the sensor completely.
</span><span style=color:#60a0b0;font-style:italic> */</span>
<span style=color:#60a0b0;font-style:italic>// #define ONEWIRE_PIN GPIO4
</span><span style=color:#60a0b0;font-style:italic>//#define SONIC_RX_PIN GPIO1
</span><span style=color:#60a0b0;font-style:italic>//#define RAIN_GAUGE_PIN GPIO5
</span><span style=color:#60a0b0;font-style:italic>//#define VH400_PIN ADC2
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020>#define DAVIS_SPEED_PIN GPIO5
</span><span style=color:#007020>#define DAVIS_DIRECTION_PIN ADC2
</span><span style=color:#007020></span>
<span style=color:#60a0b0;font-style:italic>// This defines the fallback value of mm/t if not provided by the node
</span><span style=color:#60a0b0;font-style:italic>// configuration file. The default value corresponds to a HOBO RG3.
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#007020>#define DEFAULT_MM_PER_COUNT 0.254 </span><span style=color:#60a0b0;font-style:italic>// 0.01&#34;
</span><span style=color:#60a0b0;font-style:italic></span>
<span style=color:#60a0b0;font-style:italic>/*
</span><span style=color:#60a0b0;font-style:italic> * All options below are advanced and specifically for the LoRaWAN library used.
</span><span style=color:#60a0b0;font-style:italic> * None of these values should require manual changes except when using outside
</span><span style=color:#60a0b0;font-style:italic> * the US915 zone or using ABP rather than OTAA.
</span><span style=color:#60a0b0;font-style:italic> */</span>

<span style=color:#60a0b0;font-style:italic>// OTAA parameters should be set via AT commands in the configuration file.
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#902000>uint8_t</span> devEui[] <span style=color:#666>=</span> {<span style=color:#40a070>0xC0</span>, <span style=color:#40a070>0xFF</span>, <span style=color:#40a070>0xEE</span>, <span style=color:#40a070>0xC0</span>, <span style=color:#40a070>0xFF</span>, <span style=color:#40a070>0xEE</span>, <span style=color:#40a070>0xCA</span>, <span style=color:#40a070>0xFE</span>};
<span style=color:#902000>uint8_t</span> appEui[] <span style=color:#666>=</span> {<span style=color:#40a070>0xC0</span>, <span style=color:#40a070>0xFF</span>, <span style=color:#40a070>0xEE</span>, <span style=color:#40a070>0xC0</span>, <span style=color:#40a070>0xFF</span>, <span style=color:#40a070>0xEE</span>, <span style=color:#40a070>0xCA</span>, <span style=color:#40a070>0xFE</span>};
<span style=color:#902000>uint8_t</span> appKey[] <span style=color:#666>=</span> {<span style=color:#40a070>0xC0</span>, <span style=color:#40a070>0xFF</span>, <span style=color:#40a070>0xEE</span>, <span style=color:#40a070>0xC0</span>, <span style=color:#40a070>0xFF</span>, <span style=color:#40a070>0xEE</span>, <span style=color:#40a070>0xC0</span>, <span style=color:#40a070>0xFF</span>,
                    <span style=color:#40a070>0xEE</span>, <span style=color:#40a070>0xC0</span>, <span style=color:#40a070>0xFF</span>, <span style=color:#40a070>0xEE</span>, <span style=color:#40a070>0xC0</span>, <span style=color:#40a070>0xFF</span>, <span style=color:#40a070>0xEE</span>, <span style=color:#40a070>0x42</span>};

<span style=color:#60a0b0;font-style:italic>/*
</span><span style=color:#60a0b0;font-style:italic> * While it is possible to use ABP it is not recommended, please use OTAA!
</span><span style=color:#60a0b0;font-style:italic> * OTAA is more secure and allows the node and backend to negotiate an ideal
</span><span style=color:#60a0b0;font-style:italic> * transmission rate to safe power and air-time.
</span><span style=color:#60a0b0;font-style:italic> */</span>
<span style=color:#902000>uint8_t</span> nwkSKey[] <span style=color:#666>=</span> {};
<span style=color:#902000>uint8_t</span> appSKey[] <span style=color:#666>=</span> {};
<span style=color:#902000>uint32_t</span> devAddr <span style=color:#666>=</span> (<span style=color:#902000>uint32_t</span>)<span style=color:#40a070>0x0</span>;

<span style=color:#60a0b0;font-style:italic>/*LoraWan channelsmask, default channels 0-7 sub 2*/</span>
<span style=color:#902000>uint16_t</span> userChannelsMask[<span style=color:#40a070>6</span>] <span style=color:#666>=</span> {<span style=color:#40a070>0xFF00</span>, <span style=color:#40a070>0x0000</span>, <span style=color:#40a070>0x0000</span>, <span style=color:#40a070>0x0000</span>, <span style=color:#40a070>0x0000</span>, <span style=color:#40a070>0x0000</span>};

<span style=color:#60a0b0;font-style:italic>/*LoraWan region, select in arduino IDE tools*/</span>
LoRaMacRegion_t loraWanRegion <span style=color:#666>=</span> ACTIVE_REGION;

<span style=color:#60a0b0;font-style:italic>/*LoraWan Class, Class A and Class C are supported*/</span>
DeviceClass_t loraWanClass <span style=color:#666>=</span> LORAWAN_CLASS;

<span style=color:#60a0b0;font-style:italic>/*OTAA or ABP*/</span>
<span style=color:#902000>bool</span> overTheAirActivation <span style=color:#666>=</span> LORAWAN_NETMODE;

<span style=color:#60a0b0;font-style:italic>/*ADR enable*/</span>
<span style=color:#902000>bool</span> loraWanAdr <span style=color:#666>=</span> LORAWAN_ADR;

<span style=color:#60a0b0;font-style:italic>/* set LORAWAN_Net_Reserve ON, the node could save the network info to flash,
</span><span style=color:#60a0b0;font-style:italic> * when node reset not need to join again */</span>
<span style=color:#60a0b0;font-style:italic>// bool keepNet = LORAWAN_NET_RESERVE;
</span><span style=color:#60a0b0;font-style:italic></span><span style=color:#902000>bool</span> keepNet <span style=color:#666>=</span> <span style=color:#007020>false</span>;

<span style=color:#60a0b0;font-style:italic>/* Indicates if the node is sending confirmed or unconfirmed messages */</span>
<span style=color:#902000>bool</span> isTxConfirmed <span style=color:#666>=</span> <span style=color:#007020>false</span>;

<span style=color:#60a0b0;font-style:italic>/*!
</span><span style=color:#60a0b0;font-style:italic> * Number of trials to transmit the frame, if the LoRaMAC layer did not
</span><span style=color:#60a0b0;font-style:italic> * receive an acknowledgment. The MAC performs a datarate adaptation,
</span><span style=color:#60a0b0;font-style:italic> * according to the LoRaWAN Specification V1.0.2, chapter 18.4, according
</span><span style=color:#60a0b0;font-style:italic> * to the following table:
</span><span style=color:#60a0b0;font-style:italic> *
</span><span style=color:#60a0b0;font-style:italic> * Transmission nb | Data Rate
</span><span style=color:#60a0b0;font-style:italic> * ----------------|-----------
</span><span style=color:#60a0b0;font-style:italic> * 1 (first)       | DR
</span><span style=color:#60a0b0;font-style:italic> * 2               | DR
</span><span style=color:#60a0b0;font-style:italic> * 3               | max(DR-1,0)
</span><span style=color:#60a0b0;font-style:italic> * 4               | max(DR-1,0)
</span><span style=color:#60a0b0;font-style:italic> * 5               | max(DR-2,0)
</span><span style=color:#60a0b0;font-style:italic> * 6               | max(DR-2,0)
</span><span style=color:#60a0b0;font-style:italic> * 7               | max(DR-3,0)
</span><span style=color:#60a0b0;font-style:italic> * 8               | max(DR-3,0)
</span><span style=color:#60a0b0;font-style:italic> *
</span><span style=color:#60a0b0;font-style:italic> * Note, that if NbTrials is set to 1 or 2, the MAC will not decrease
</span><span style=color:#60a0b0;font-style:italic> * the datarate, in case the LoRaMAC layer did not receive an acknowledgment
</span><span style=color:#60a0b0;font-style:italic> */</span>
<span style=color:#902000>uint8_t</span> confirmedNbTrials <span style=color:#666>=</span> <span style=color:#40a070>4</span>;
</code></pre></div><h3 id=vh400cpp><code>VH400.cpp</code></h3>
<div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#007020>#include</span> <span style=color:#007020>&#34;Arduino.h&#34;</span><span style=color:#007020>
</span><span style=color:#007020></span>
<span style=color:#902000>float</span> <span style=color:#06287e>read_VH400</span>(<span style=color:#902000>uint8_t</span> VH400_PIN) {

  <span style=color:#902000>float</span> vh400_voltage <span style=color:#666>=</span> analogReadmV(VH400_PIN) <span style=color:#666>/</span> <span style=color:#40a070>1000.0</span>;
  <span style=color:#902000>float</span> VWC;

  <span style=color:#60a0b0;font-style:italic>// Calculate VWC based on voltages provided by vendor:
</span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#60a0b0;font-style:italic>// https://vegetronix.com/Products/VH400/VH400-Piecewise-Curve.phtml
</span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#007020;font-weight:700>if</span> (vh400_voltage <span style=color:#666>&lt;=</span> <span style=color:#40a070>1.1</span>) {
    VWC <span style=color:#666>=</span> <span style=color:#40a070>10</span> <span style=color:#666>*</span> vh400_voltage <span style=color:#666>-</span> <span style=color:#40a070>1</span>;
  } <span style=color:#007020;font-weight:700>else</span> <span style=color:#007020;font-weight:700>if</span> (vh400_voltage <span style=color:#666>&lt;=</span> <span style=color:#40a070>1.3</span>) {
    VWC <span style=color:#666>=</span> <span style=color:#40a070>25</span> <span style=color:#666>*</span> vh400_voltage <span style=color:#666>-</span> <span style=color:#40a070>17.5</span>;
  } <span style=color:#007020;font-weight:700>else</span> <span style=color:#007020;font-weight:700>if</span> (vh400_voltage <span style=color:#666>&lt;=</span> <span style=color:#40a070>1.82</span>) {
    VWC <span style=color:#666>=</span> <span style=color:#40a070>48.08</span> <span style=color:#666>*</span> vh400_voltage <span style=color:#666>-</span> <span style=color:#40a070>47.5</span>;
  } <span style=color:#007020;font-weight:700>else</span> <span style=color:#007020;font-weight:700>if</span> (vh400_voltage <span style=color:#666>&lt;=</span> <span style=color:#40a070>2.2</span>) {
    VWC <span style=color:#666>=</span> <span style=color:#40a070>26.32</span> <span style=color:#666>*</span> vh400_voltage <span style=color:#666>-</span> <span style=color:#40a070>7.89</span>;
  } <span style=color:#007020;font-weight:700>else</span> <span style=color:#007020;font-weight:700>if</span> (vh400_voltage <span style=color:#666>&lt;=</span> <span style=color:#40a070>3.0</span>) {
    VWC <span style=color:#666>=</span> <span style=color:#40a070>62.5</span> <span style=color:#666>*</span> vh400_voltage <span style=color:#666>-</span> <span style=color:#40a070>87.5</span>;
  } <span style=color:#007020;font-weight:700>else</span> {
    VWC <span style=color:#666>=</span> <span style=color:#40a070>0.0</span>;
  }
  <span style=color:#007020;font-weight:700>return</span> (VWC);
}
</code></pre></div><h3 id=mb7389cpp><code>MB7389.cpp</code></h3>
<div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#007020>#include</span> <span style=color:#007020>&lt;softSerial.h&gt;</span><span style=color:#007020>
</span><span style=color:#007020></span>
<span style=color:#902000>uint32_t</span> <span style=color:#06287e>get_sonic_distance</span>(softSerial softwareSerial, <span style=color:#902000>uint32_t</span> count) {
  boolean foundValue;
  boolean foundStart;
  String inString;
  <span style=color:#902000>uint32_t</span> measurements <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
  <span style=color:#902000>uint32_t</span> total <span style=color:#666>=</span> <span style=color:#40a070>0</span>;
  <span style=color:#902000>uint32_t</span> start;

  softwareSerial.begin(<span style=color:#40a070>9600</span>);
  <span style=color:#007020;font-weight:700>while</span> (<span style=color:#666>!</span>softwareSerial.available()) {
  }

  <span style=color:#60a0b0;font-style:italic>// Run loop until enough measurements were read
</span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#007020;font-weight:700>while</span> (measurements <span style=color:#666>&lt;</span> count) {
    <span style=color:#60a0b0;font-style:italic>// Since measurements may fail resulting in a retry after 1/6 seconds, store
</span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#60a0b0;font-style:italic>// the start time so one a measurement is successfully read, start the next
</span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#60a0b0;font-style:italic>// measurement exactly a second later.
</span><span style=color:#60a0b0;font-style:italic></span>    start <span style=color:#666>=</span> millis();

    <span style=color:#60a0b0;font-style:italic>// Reset variables used to find measurement
</span><span style=color:#60a0b0;font-style:italic></span>    foundStart <span style=color:#666>=</span> <span style=color:#007020>false</span>;
    foundValue <span style=color:#666>=</span> <span style=color:#007020>false</span>;
    inString <span style=color:#666>=</span> <span style=color:#4070a0>&#34;&#34;</span>;

    <span style=color:#60a0b0;font-style:italic>// Flush software serial input
</span><span style=color:#60a0b0;font-style:italic></span>    softwareSerial.flush();

    <span style=color:#60a0b0;font-style:italic>// Loop until a single measurement is found
</span><span style=color:#60a0b0;font-style:italic></span>    <span style=color:#007020;font-weight:700>while</span> (<span style=color:#666>!</span>foundValue) {
      <span style=color:#007020;font-weight:700>if</span> (softwareSerial.available()) {
        <span style=color:#902000>char</span> inChar <span style=color:#666>=</span> softwareSerial.read();
        <span style=color:#007020;font-weight:700>if</span> (foundStart <span style=color:#666>==</span> <span style=color:#007020>false</span>) {
          <span style=color:#60a0b0;font-style:italic>// New measurements begin with the character `R`
</span><span style=color:#60a0b0;font-style:italic></span>          <span style=color:#007020;font-weight:700>if</span> (inChar <span style=color:#666>==</span> <span style=color:#4070a0>&#39;R&#39;</span>) {
            foundStart <span style=color:#666>=</span> <span style=color:#007020>true</span>;
          } <span style=color:#007020;font-weight:700>else</span> {
            <span style=color:#60a0b0;font-style:italic>// If not, skip the letter and repeat
</span><span style=color:#60a0b0;font-style:italic></span>            softwareSerial.read();
          }
        } <span style=color:#007020;font-weight:700>else</span> {
          <span style=color:#60a0b0;font-style:italic>// Measurements end with character `\r`. If any other value is found
</span><span style=color:#60a0b0;font-style:italic></span>          <span style=color:#60a0b0;font-style:italic>// add it to our measurement.
</span><span style=color:#60a0b0;font-style:italic></span>          <span style=color:#007020;font-weight:700>if</span> (inChar <span style=color:#666>!=</span> <span style=color:#4070a0>&#39;\r&#39;</span>) {
            inString <span style=color:#666>+=</span> inChar;
          } <span style=color:#007020;font-weight:700>else</span> {
            <span style=color:#60a0b0;font-style:italic>// If found character is `\r` and therefore end of a measurement,
</span><span style=color:#60a0b0;font-style:italic></span>            <span style=color:#60a0b0;font-style:italic>// check if the length is actually four character. If not, repeat
</span><span style=color:#60a0b0;font-style:italic></span>            <span style=color:#60a0b0;font-style:italic>// the process.
</span><span style=color:#60a0b0;font-style:italic></span>            <span style=color:#007020;font-weight:700>if</span> (inString.length() <span style=color:#666>!=</span> <span style=color:#40a070>4</span>) {
              Serial.println(<span style=color:#4070a0>&#34;incomplete measurement&#34;</span>);
              foundStart <span style=color:#666>=</span> <span style=color:#007020>false</span>;
              inString <span style=color:#666>=</span> <span style=color:#4070a0>&#34;&#34;</span>;
            } <span style=color:#007020;font-weight:700>else</span> {
              <span style=color:#60a0b0;font-style:italic>// Found available measurement, increase counter and begin again
</span><span style=color:#60a0b0;font-style:italic></span>              foundValue <span style=color:#666>=</span> <span style=color:#007020>true</span>;
              total <span style=color:#666>+=</span> inString.toInt();
              measurements <span style=color:#666>+=</span> <span style=color:#40a070>1</span>;
              <span style=color:#60a0b0;font-style:italic>// Wait 1 second minus the time it took to read the last
</span><span style=color:#60a0b0;font-style:italic></span>              <span style=color:#60a0b0;font-style:italic>// measurement
</span><span style=color:#60a0b0;font-style:italic></span>              delay(<span style=color:#40a070>1000</span> <span style=color:#666>-</span> (millis() <span style=color:#666>-</span> start));
            }
          }
        }
      } <span style=color:#007020;font-weight:700>else</span> {
        <span style=color:#60a0b0;font-style:italic>// Give the software serial more time to read characters
</span><span style=color:#60a0b0;font-style:italic></span>        delay(<span style=color:#40a070>50</span>);
      }
    }
  }
  <span style=color:#60a0b0;font-style:italic>// Return average of measurements and convert it to cm (sensor returns mm)
</span><span style=color:#60a0b0;font-style:italic></span>  <span style=color:#007020;font-weight:700>return</span> (total <span style=color:#666>/</span> (count <span style=color:#666>*</span> <span style=color:#40a070>10</span>)); <span style=color:#60a0b0;font-style:italic>// to cm
</span><span style=color:#60a0b0;font-style:italic></span>}
</code></pre></div><h1 id=references>References</h1>
<p>[1] Khutsoane, Oratile, Bassey Isong, and Adnan M. Abu-Mahfouz. &ldquo;IoT devices and
applications based on LoRa/LoRaWAN.&rdquo; IECON 2017-43rd Annual Conference of the
IEEE Industrial Electronics Society. IEEE, 2017.</p>
<p>[2] Rizzi, Mattia, et al. &ldquo;Evaluation of the IoT LoRaWAN solution for
distributed measurement applications.&rdquo; IEEE Transactions on Instrumentation and
Measurement 66.12 (2017): 3340-3349.</p>
<p>[3] Davcev, Danco, et al. &ldquo;IoT agriculture system based on LoRaWAN.&rdquo; 2018 14th
IEEE International Workshop on Factory Communication Systems (WFCS). IEEE, 2018.</p>
</content>
<p>
<a href=https://aparcar.org/blog/lora/>#lora</a>
<a href=https://aparcar.org/blog/lorawan/>#lorawan</a>
<a href=https://aparcar.org/blog/iot/>#iot</a>
</p>
</main>
<footer>
</footer>
</body>
</html>