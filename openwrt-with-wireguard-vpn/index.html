<!doctype html><html lang=en-US><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><title>OpenWrt with Wireguard VPN | aparcar</title>
<meta name=title content="OpenWrt with Wireguard VPN"><meta name=description content="There are many many many tutorials on how to setup
Wireguard VPN on Debian (Ubuntu) and OpenWrt, however I want to keep it here for
my personal notes.  This setup describes a network address traversal (NAT)
tunnel server as well as a pinging client. The client can connect to the
Internet using the tunnel servers IP and the tunnel server can login to a client
since it pings the tunnel server with its address and open port."><meta name=keywords content><meta property="og:url" content="https://aparcar.org/openwrt-with-wireguard-vpn/"><meta property="og:site_name" content="aparcar"><meta property="og:title" content="OpenWrt with Wireguard VPN"><meta property="og:description" content="There are many many many tutorials on how to setup Wireguard VPN on Debian (Ubuntu) and OpenWrt, however I want to keep it here for my personal notes. This setup describes a network address traversal (NAT) tunnel server as well as a pinging client. The client can connect to the Internet using the tunnel servers IP and the tunnel server can login to a client since it pings the tunnel server with its address and open port."><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-10-26T00:00:00+00:00"><meta property="article:modified_time" content="2021-10-26T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="OpenWrt with Wireguard VPN"><meta name=twitter:description content="There are many many many tutorials on how to setup Wireguard VPN on Debian (Ubuntu) and OpenWrt, however I want to keep it here for my personal notes. This setup describes a network address traversal (NAT) tunnel server as well as a pinging client. The client can connect to the Internet using the tunnel servers IP and the tunnel server can login to a client since it pings the tunnel server with its address and open port."><meta itemprop=name content="OpenWrt with Wireguard VPN"><meta itemprop=description content="There are many many many tutorials on how to setup Wireguard VPN on Debian (Ubuntu) and OpenWrt, however I want to keep it here for my personal notes. This setup describes a network address traversal (NAT) tunnel server as well as a pinging client. The client can connect to the Internet using the tunnel servers IP and the tunnel server can login to a client since it pings the tunnel server with its address and open port."><meta itemprop=datePublished content="2021-10-26T00:00:00+00:00"><meta itemprop=dateModified content="2021-10-26T00:00:00+00:00"><meta itemprop=wordCount content="959"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#eee}pre code{border-left:1px solid #999;color:#555;display:block;padding:10px;white-space:pre-wrap}blockquote{border-left:1px solid #999;color:#555;padding-left:10px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}</style><link rel=stylesheet href=/style.css></head><body><header><a href=/ class=title><h2>aparcar</h2></a><nav><a href=/>Home</a>
<a href=/commitments/>Commitments</a>
<a href=/blog>Blog</a></nav></header><main><h1>OpenWrt with Wireguard VPN</h1><p><i><time datetime=2021-10-26 pubdate>26 Oct, 2021</time></i></p><content><p>There are <a href=http://chrisbuchan.co.uk/computing/wireguard-setup-openwrt/>many</a> <a href=https://openwrt.org/docs/guide-user/services/vpn/wireguard/server>many</a> <a href=https://casept.github.io/post/wireguard-server-on-openwrt-router/>many</a> tutorials on how to setup
Wireguard VPN on Debian (Ubuntu) and OpenWrt, however I want to keep it here for
my personal notes. This setup describes a <em>network address traversal</em> (NAT)
tunnel server as well as a <em>pinging</em> client. The client can connect to the
Internet using the tunnel servers IP and the tunnel server can login to a client
since it <em>pings</em> the tunnel server with its address and open port.</p><h2 id=setup-tunnel-server>Setup tunnel server</h2><p>While the tunnel server can also be a OpenWrt device, this setup describes using
a Debian (Ubuntu) server. First install <code>wireguard-tools</code> since we&rsquo;ll need the
<code>wg-quick</code> tool in a moment.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>apt update
</span></span><span style=display:flex><span>apt install wireguard-tools
</span></span></code></pre></div><p>Enable IPv4 forwarding with the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sysctl -w net.ipv4.ip_forward<span style=color:#666>=</span><span style=color:#40a070>1</span>
</span></span></code></pre></div><p>To be persistent this option should be uncommented/added to <code>/etc/sysctl.conf</code>.</p><p>On Debian each Wireguard interface is defined in a single configuration file
stored in <code>/etc/wireguard/</code>. A common approach is to call the configuration file
for the first interface <code>wg0.conf</code>. The configuration contains an interface
definition and any number of peers.</p><p>The interface section contains the used VPN IP address including subnet size as
well as a port. The port will be used by connecting clients.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#60a0b0;font-style:italic># /etc/wireguard/wg0.conf</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>[Interface]</span>
</span></span><span style=display:flex><span><span style=color:#4070a0>Address</span> <span style=color:#666>=</span> <span style=color:#4070a0>10.0.0.1/24</span>
</span></span><span style=display:flex><span><span style=color:#4070a0>ListenPort</span> <span style=color:#666>=</span> <span style=color:#4070a0>51820</span>
</span></span><span style=display:flex><span><span style=color:#4070a0>PostUp</span> <span style=color:#666>=</span> <span style=color:#4070a0>iptables -A FORWARD -i %i -j ACCEPT; iptables -t nat -A POSTROUTING -o enp2s0 -j MASQUERADE</span>
</span></span><span style=display:flex><span><span style=color:#4070a0>PostDown</span> <span style=color:#666>=</span> <span style=color:#4070a0>iptables -D FORWARD -i %i -j ACCEPT; iptables -t nat -D POSTROUTING -o enp2s0 -j MASQUERADE</span>
</span></span></code></pre></div><p>The <code>Address</code> is important since it defines the number of clients that can
connect. This demo setup uses a <code>/24</code> network while real setups should use much
bigger subnets.</p><p>The <code>PostUp</code> and <code>PostDown</code> commands are run by the <code>wg-quick</code> command to enable
<em>NAT</em> for the interface. The port is flexible and just have to be publicly
reachable.</p><p>The Wireguard protocol is designed to stay silent if the incoming packets are
not valid. Valid means the packet comes from a known peer and is encrypted with
its private key. If the package is not valid Wireguard will not react at all,
making the port seem closed. However if a firewall is in place the selected
<code>Port</code> must be opened.</p><p>Next a private key is added, assuming the <code>wg0.conf</code> file only contains the
options shown above, the following command will add a private key:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#007020>echo</span> <span style=color:#4070a0>&#34;PrivateKey = </span><span style=color:#007020;font-weight:700>$(</span>wg genkey<span style=color:#007020;font-weight:700>)</span><span style=color:#4070a0>&#34;</span> &gt;&gt; /etc/wireguard/wg0.conf
</span></span></code></pre></div><p>To enable the interface the <code>wg-quick</code> command is used as shown below:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>wg-quick up wg0
</span></span></code></pre></div><p>Running the <code>wg</code> command should now present the interface including the public
key. The public key should be copied since it&rsquo;s needed in the next step, where a
client is setup.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>interface: wg0
</span></span><span style=display:flex><span>  public key: 25ljRJgjoxxxxxxxxxxxxxxxxxxxx6/01xV4f7GB8<span style=color:#666>=</span>
</span></span><span style=display:flex><span>  private key: <span style=color:#666>(</span>hidden<span style=color:#666>)</span>
</span></span><span style=display:flex><span>  listening port: <span style=color:#40a070>51820</span>
</span></span></code></pre></div><p>In the next section a client is setup and the clients public key plus IP address
will then be added to the tunnel server Wireguard configuration.</p><h2 id=add-a-client-aka-peer>Add a client (aka peer)</h2><p>The following commands are run on a device running OpenWrt. Install the
<code>wireguard-tools</code> since the <code>wg</code> tool is required to setup the Wireguard
protocols.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>opkg update
</span></span><span style=display:flex><span>opkg install wireguard-tools
</span></span></code></pre></div><p>Next export env variables containing the tunnel servers public key, it&rsquo;s
endpoint including port and the devices IP address. The device IP address should
not yet exists on the server.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#007020>export</span> <span style=color:#bb60d5>SERVER_WG_PUBKEY</span><span style=color:#666>=</span><span style=color:#4070a0>&#39;25ljRJgjoxxxxxxxxxxxxxxxxxxxx61xV4f7GB8=&#39;</span>
</span></span><span style=display:flex><span><span style=color:#007020>export</span> <span style=color:#bb60d5>ENDPOINT_HOST</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;148.xxx.xxx.xxx&#34;</span>
</span></span><span style=display:flex><span><span style=color:#007020>export</span> <span style=color:#bb60d5>ENDPOINT_PORT</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;51820&#34;</span>
</span></span><span style=display:flex><span><span style=color:#007020>export</span> <span style=color:#bb60d5>DEVICE_IP</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;10.0.0.3/24&#34;</span>
</span></span></code></pre></div><p>Once the variables are set a new interface called <code>wg0</code> is added to the network
configuration. The commands automatically create a private key.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>uci <span style=color:#007020>set</span> network.wg0<span style=color:#666>=</span>interface
</span></span><span style=display:flex><span>uci <span style=color:#007020>set</span> network.wg0.proto<span style=color:#666>=</span><span style=color:#4070a0>&#39;wireguard&#39;</span>
</span></span><span style=display:flex><span>uci <span style=color:#007020>set</span> network.wg0.private_key<span style=color:#666>=</span><span style=color:#4070a0>&#34;</span><span style=color:#007020;font-weight:700>$(</span>wg genkey<span style=color:#007020;font-weight:700>)</span><span style=color:#4070a0>&#34;</span>
</span></span><span style=display:flex><span>uci <span style=color:#007020>set</span> network.wg0.addresses<span style=color:#666>=</span><span style=color:#4070a0>&#34;</span><span style=color:#bb60d5>$DEVICE_IP</span><span style=color:#4070a0>&#34;</span>
</span></span><span style=display:flex><span>uci <span style=color:#007020>set</span> network.wg0.proto<span style=color:#666>=</span><span style=color:#4070a0>&#39;wireguard&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>uci <span style=color:#007020>set</span> network.tunnelserver<span style=color:#666>=</span>wireguard_wg0
</span></span><span style=display:flex><span>uci <span style=color:#007020>set</span> network.tunnelserver.description<span style=color:#666>=</span><span style=color:#4070a0>&#39;tunnel-server&#39;</span>
</span></span><span style=display:flex><span>uci <span style=color:#007020>set</span> network.tunnelserver.allowed_ips<span style=color:#666>=</span><span style=color:#4070a0>&#39;0.0.0.0/0&#39;</span>
</span></span><span style=display:flex><span>uci <span style=color:#007020>set</span> network.tunnelserver.endpoint_host<span style=color:#666>=</span><span style=color:#4070a0>&#34;</span><span style=color:#bb60d5>$ENDPOINT_HOST</span><span style=color:#4070a0>&#34;</span>
</span></span><span style=display:flex><span>uci <span style=color:#007020>set</span> network.tunnelserver.endpoint_port<span style=color:#666>=</span><span style=color:#4070a0>&#34;</span><span style=color:#bb60d5>$ENDPOINT_PORT</span><span style=color:#4070a0>&#34;</span>
</span></span><span style=display:flex><span>uci <span style=color:#007020>set</span> network.tunnelserver.persistent_keepalive<span style=color:#666>=</span><span style=color:#40a070>25</span>
</span></span><span style=display:flex><span>uci <span style=color:#007020>set</span> network.tunnelserver.public_key<span style=color:#666>=</span><span style=color:#4070a0>&#34;</span><span style=color:#bb60d5>$SERVER_WG_PUBKEY</span><span style=color:#4070a0>&#34;</span>
</span></span><span style=display:flex><span>uci <span style=color:#007020>set</span> network.tunnelserver.route_allowed_ips<span style=color:#666>=</span><span style=color:#4070a0>&#39;true&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>uci commit network
</span></span></code></pre></div><p>After restarting the network via <code>service network restart</code> the new Wireguard
interface should be available. To see if it worked run the <code>wg</code> command.</p><blockquote><p>Restarting the network will route all traffic but the tunnel IP connection
over the Wireguard interface. Since the setup is not yet done, connectivity is
lost until the tunnel server configuration is updated. If you&rsquo;re setting up a
remote device the <code>route_allowed_ips</code> should be set to <code>false</code> until both ends
are setup.</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>interface: wg0
</span></span><span style=display:flex><span>  public key: <span style=color:#bb60d5>NgvbLeF4cVSxxxxxxxxS84R7wdzlXzs</span><span style=color:#666>=</span>
</span></span><span style=display:flex><span>  private key: <span style=color:#666>(</span>hidden<span style=color:#666>)</span>
</span></span><span style=display:flex><span>  listening port: <span style=color:#40a070>54969</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>peer: 25ljRJgjo7xyxxxxxxxxxxxxxx/01xV4f7GB8<span style=color:#666>=</span>
</span></span><span style=display:flex><span>  endpoint: 148.xxx.xxx.xxx:51xxx
</span></span><span style=display:flex><span>  allowed ips: 0.0.0.0/0
</span></span><span style=display:flex><span>  transfer: <span style=color:#40a070>0</span> B received, <span style=color:#40a070>148</span> B sent
</span></span><span style=display:flex><span>  persistent keepalive: every <span style=color:#40a070>25</span> seconds
</span></span></code></pre></div><h2 id=add-new-peer-to-tunnel-server>Add new peer to tunnel server</h2><p>The tunnel server doesn&rsquo;t know about the new peer yet, so it has to be added to
the peers network configuration. This is done by adding three lines to the
<code>/etc/wireguard/wg0.conf</code> file. The following lines should be added:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#666>[</span>Peer<span style=color:#666>]</span>
</span></span><span style=display:flex><span><span style=color:#bb60d5>PublicKey</span> <span style=color:#666>=</span> &lt;peer_public_key&gt;
</span></span><span style=display:flex><span><span style=color:#bb60d5>AllowedIPs</span> <span style=color:#666>=</span> &lt;peer_ip_address&gt;
</span></span></code></pre></div><p>The <code>PublicKey</code> and <code>AllowedIPs</code> should be copied from the client in the last
step. Once added a configuration reload happens via the following command:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>wg syncconf wg0 &lt;<span style=color:#666>(</span>wg-quick strip wg0<span style=color:#666>)</span>
</span></span></code></pre></div><p>Running <code>wg</code> on the tunnel server should show an existing established connection
since the client will try to ping the tunnel server every 25 seconds.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>interface: wg0
</span></span><span style=display:flex><span>  public key: 25ljRJgjoxxxxxxxxxxxxxxxxxxxx/01xV4f7GB8<span style=color:#666>=</span>
</span></span><span style=display:flex><span>  private key: <span style=color:#666>(</span>hidden<span style=color:#666>)</span>
</span></span><span style=display:flex><span>  listening port: <span style=color:#40a070>51820</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>peer: <span style=color:#bb60d5>NgvbLeF4cVSxTxxxxxxxxxxxxx84R7wdzlXzs</span><span style=color:#666>=</span>
</span></span><span style=display:flex><span>  endpoint: 168.xxx.xxx.xxx:55142
</span></span><span style=display:flex><span>  allowed ips: 10.0.0.3/32
</span></span><span style=display:flex><span>  latest handshake: <span style=color:#40a070>6</span> seconds ago
</span></span><span style=display:flex><span>  transfer: 17.87 KiB received, 29.40 KiB sent
</span></span></code></pre></div><p>A ping command like <code>ping 10.0.0.3</code> on the tunnel server should show a working
connection.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ping 10.0.0.03 -c3
</span></span><span style=display:flex><span>PING 10.0.0.03 <span style=color:#666>(</span>10.0.0.3<span style=color:#666>)</span> 56<span style=color:#666>(</span>84<span style=color:#666>)</span> bytes of data.
</span></span><span style=display:flex><span><span style=color:#40a070>64</span> bytes from 10.0.0.3: <span style=color:#bb60d5>icmp_seq</span><span style=color:#666>=</span><span style=color:#40a070>1</span> <span style=color:#bb60d5>ttl</span><span style=color:#666>=</span><span style=color:#40a070>64</span> <span style=color:#bb60d5>time</span><span style=color:#666>=</span><span style=color:#40a070>207</span> ms
</span></span><span style=display:flex><span><span style=color:#40a070>64</span> bytes from 10.0.0.3: <span style=color:#bb60d5>icmp_seq</span><span style=color:#666>=</span><span style=color:#40a070>2</span> <span style=color:#bb60d5>ttl</span><span style=color:#666>=</span><span style=color:#40a070>64</span> <span style=color:#bb60d5>time</span><span style=color:#666>=</span><span style=color:#40a070>229</span> ms
</span></span><span style=display:flex><span><span style=color:#40a070>64</span> bytes from 10.0.0.3: <span style=color:#bb60d5>icmp_seq</span><span style=color:#666>=</span><span style=color:#40a070>3</span> <span style=color:#bb60d5>ttl</span><span style=color:#666>=</span><span style=color:#40a070>64</span> <span style=color:#bb60d5>time</span><span style=color:#666>=</span><span style=color:#40a070>252</span> ms
</span></span></code></pre></div><p>From now on the client router will route all it&rsquo;s traffic over the tunnel
server. To disable this behaviour it is possible to set the <em>allowed IPs</em> for
the tunnel server to a specific IP instead.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>uci <span style=color:#007020>set</span> network.tunnelserver.allowed_ips<span style=color:#666>=</span><span style=color:#4070a0>&#39;10.0.0.1/24&#39;</span>
</span></span></code></pre></div><p>This way not all traffic but only the tunnel server specific traffic is
forwarded.</p></content><p></p></main><footer></footer></body></html>