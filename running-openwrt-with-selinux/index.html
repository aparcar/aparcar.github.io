<!doctype html><html lang=en-US><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><title>Running OpenWrt with SELinux | aparcar</title>
<meta name=title content="Running OpenWrt with SELinux"><meta name=description content="This blog post describes the creation and testing of OpenWrt images running SELinux to improve security. The support is still limited and not ready for any productive usage, however this post should give a basic idea of its current state.
History Back in November 2019 Thomas Petazzoni sent a first patchset adding optional SELinux support to OpenWrt. Due to the complexity of integrating SELinux into the OpenWrt build system and missing bits in the patchset, the patches never made it into the main branch."><meta name=keywords content><meta property="og:url" content="https://aparcar.org/running-openwrt-with-selinux/"><meta property="og:site_name" content="aparcar"><meta property="og:title" content="Running OpenWrt with SELinux"><meta property="og:description" content="This blog post describes the creation and testing of OpenWrt images running SELinux to improve security. The support is still limited and not ready for any productive usage, however this post should give a basic idea of its current state.
History Back in November 2019 Thomas Petazzoni sent a first patchset adding optional SELinux support to OpenWrt. Due to the complexity of integrating SELinux into the OpenWrt build system and missing bits in the patchset, the patches never made it into the main branch."><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2020-09-11T11:04:01-10:00"><meta property="article:modified_time" content="2020-09-11T11:04:01-10:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Running OpenWrt with SELinux"><meta name=twitter:description content="This blog post describes the creation and testing of OpenWrt images running SELinux to improve security. The support is still limited and not ready for any productive usage, however this post should give a basic idea of its current state.
History Back in November 2019 Thomas Petazzoni sent a first patchset adding optional SELinux support to OpenWrt. Due to the complexity of integrating SELinux into the OpenWrt build system and missing bits in the patchset, the patches never made it into the main branch."><meta itemprop=name content="Running OpenWrt with SELinux"><meta itemprop=description content="This blog post describes the creation and testing of OpenWrt images running SELinux to improve security. The support is still limited and not ready for any productive usage, however this post should give a basic idea of its current state.
History Back in November 2019 Thomas Petazzoni sent a first patchset adding optional SELinux support to OpenWrt. Due to the complexity of integrating SELinux into the OpenWrt build system and missing bits in the patchset, the patches never made it into the main branch."><meta itemprop=datePublished content="2020-09-11T11:04:01-10:00"><meta itemprop=dateModified content="2020-09-11T11:04:01-10:00"><meta itemprop=wordCount content="648"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#eee}pre code{border-left:1px solid #999;color:#555;display:block;padding:10px;white-space:pre-wrap}blockquote{border-left:1px solid #999;color:#555;padding-left:10px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}</style><link rel=stylesheet href=/style.css></head><body><header><a href=/ class=title><h2>aparcar</h2></a><nav><a href=/>Home</a>
<a href=/commitments/>Commitments</a>
<a href=/blog>Blog</a></nav></header><main><h1>Running OpenWrt with SELinux</h1><p><i><time datetime=2020-09-11 pubdate>11 Sep, 2020</time></i></p><content><p>This blog post describes the creation and testing of OpenWrt images running
SELinux to improve security. The support is still limited and not ready for any
productive usage, however this post should give a basic idea of its current
state.</p><h2 id=history>History</h2><p>Back in November 2019 Thomas Petazzoni sent a <a href=https://lists.infradead.org/pipermail/openwrt-devel/2019-November/025973.html>first patchset</a> adding optional
SELinux support to OpenWrt. Due to the complexity of integrating SELinux into
the OpenWrt build system and missing bits in the patchset, the patches never
made it into the main branch.</p><p>In July 2020 W. Michael Petullo gave the patchset a <a href=https://github.com/openwrt/openwrt/pull/3207>second spin</a>, updated
legacy Python2 to Python3, rebased everything and reworked all change requests
from the reviewers. Special thanks to Daniel Golle. Due to the deep integration
of SELinux inside the operating system special versions of <code>busybox</code>, <code>procd</code>
and <code>f2fs-tools</code> <a href=https://github.com/openwrt/openwrt/pull/3303>were created</a>, keeping the regular (non SELinux)
images small while allowing to integrate the additional SELinux feature via
package installations.</p><h2 id=creating-images>Creating images</h2><p>To try SELinux on OpenWrt it is currently required to compile the Kernel with
additional options. There are ideas to provide dual Kernel ImageBuilders with a
regular and a SELinux ready version, however this isn&rsquo;t ready just yet.</p><p>You&rsquo;ll need a OpenWrt <a href=https://openwrt.org/docs/guide-developer/quickstart-build-images>build system</a> and a bit of time!</p><p>As of 2020/09 only <code>x86/64</code>, <code>armvirt/64</code> and <code>ath79/generc</code> using a <em>squashfs</em>
filesystem where tested with SELinux, if you use a different target, please
share your results.</p><p>The following build options are required:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Global build settings -&gt;
</span></span><span style=display:flex><span>	<span style=color:#60a0b0;font-style:italic># CONFIG_TARGET_ROOTFS_SECURITY_LABELS=y</span>
</span></span><span style=display:flex><span>	<span style=color:#666>[</span>*<span style=color:#666>]</span> Enable rootfs security labels
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	Kernel build options -&gt;
</span></span><span style=display:flex><span>		<span style=color:#60a0b0;font-style:italic># CONFIG_KERNEL_SECURITY_SELINUX=y</span>
</span></span><span style=display:flex><span>		<span style=color:#666>[</span>*<span style=color:#666>]</span> NSA SELinux Support
</span></span></code></pre></div><p>These options will automatically select the package <code>refpolicy</code> to set labels
inside the created <code>squashfs</code> filesystem.</p><p>Select the SELinux variants of <code>procd</code>, <code>busybox</code> and (optionally)
<code>mkf2fs</code>. Be sure to deselect the <em>regular</em> versions as there is currently
a dependency error if both variants are selected.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Base system -&gt;
</span></span><span style=display:flex><span>	&lt;*&gt; busybox-selinux
</span></span><span style=display:flex><span>	&lt;*&gt; procd-selinux
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Utilities -&gt;
</span></span><span style=display:flex><span>	Filesystem -&gt;
</span></span><span style=display:flex><span>		<span style=color:#60a0b0;font-style:italic># optional: only if target uses f2fs</span>
</span></span><span style=display:flex><span>		&lt;*&gt; mkf2fs-selinux			
</span></span></code></pre></div><h2 id=running>Running</h2><p>The following will run an <code>armvirt/64</code> image:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#bb60d5>BIN_DIR</span><span style=color:#666>=</span>./bin/targets/armvirt/64
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>qemu-system-aarch64 <span style=color:#4070a0;font-weight:700>\ </span>
</span></span><span style=display:flex><span>        -M virt <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>        -append <span style=color:#4070a0>&#34;console=ttyAMA0,115200 root=/dev/vda&#34;</span> <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>        -cpu cortex-a57 <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>        -device virtio-blk-device,drive<span style=color:#666>=</span>hd <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>        -drive <span style=color:#bb60d5>file</span><span style=color:#666>=</span><span style=color:#4070a0>&#34;</span><span style=color:#bb60d5>$BIN_DIR</span><span style=color:#4070a0>/openwrt-armvirt-64-rootfs-squashfs.img&#34;</span>,if<span style=color:#666>=</span>none,format<span style=color:#666>=</span>raw,id<span style=color:#666>=</span>hd <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>        -kernel <span style=color:#4070a0>&#34;</span><span style=color:#bb60d5>$BIN_DIR</span><span style=color:#4070a0>/openwrt-armvirt-64-Image&#34;</span> <span style=color:#4070a0;font-weight:700>\
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-weight:700></span>        -nographic 
</span></span></code></pre></div><p>A boot log is written directly to the used terminal and should show lines like the following:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#666>[</span>    0.002483<span style=color:#666>]</span> LSM: Security Framework initializing
</span></span><span style=display:flex><span><span style=color:#666>[</span>    0.005608<span style=color:#666>]</span> SELinux:  Initializing.
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#666>[</span>    2.732347<span style=color:#666>]</span> SELinux:  policy capability <span style=color:#bb60d5>network_peer_controls</span><span style=color:#666>=</span><span style=color:#40a070>1</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>    2.732662<span style=color:#666>]</span> SELinux:  policy capability <span style=color:#bb60d5>open_perms</span><span style=color:#666>=</span><span style=color:#40a070>1</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>    2.732773<span style=color:#666>]</span> SELinux:  policy capability <span style=color:#bb60d5>extended_socket_class</span><span style=color:#666>=</span><span style=color:#40a070>1</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>    2.732899<span style=color:#666>]</span> SELinux:  policy capability <span style=color:#bb60d5>always_check_network</span><span style=color:#666>=</span><span style=color:#40a070>0</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>    2.733022<span style=color:#666>]</span> SELinux:  policy capability <span style=color:#bb60d5>cgroup_seclabel</span><span style=color:#666>=</span><span style=color:#40a070>1</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>    2.733132<span style=color:#666>]</span> SELinux:  policy capability <span style=color:#bb60d5>nnp_nosuid_transition</span><span style=color:#666>=</span><span style=color:#40a070>1</span>
</span></span><span style=display:flex><span><span style=color:#666>[</span>    2.753174<span style=color:#666>]</span> audit: <span style=color:#bb60d5>type</span><span style=color:#666>=</span><span style=color:#40a070>1403</span> audit<span style=color:#666>(</span>1599863280.884:2<span style=color:#666>)</span>: <span style=color:#bb60d5>auid</span><span style=color:#666>=</span><span style=color:#40a070>4294967295</span> <span style=color:#bb60d5>ses</span><span style=color:#666>=</span><span style=color:#40a070>4294967295</span> <span style=color:#bb60d5>lsm</span><span style=color:#666>=</span>selinux <span style=color:#bb60d5>res</span><span style=color:#666>=</span><span style=color:#40a070>1</span>
</span></span></code></pre></div><p>If <code>refpolicy</code> worked all files should received an initial label:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>root@OpenWrt:/# ls -Z
</span></span><span style=display:flex><span>system_u:object_r:bin_t          bin
</span></span><span style=display:flex><span>system_u:object_r:tmpfs_t        dev
</span></span><span style=display:flex><span>system_u:object_r:etc_t          etc
</span></span><span style=display:flex><span>system_u:object_r:default_t      init
</span></span><span style=display:flex><span>system_u:object_r:lib_t          lib
</span></span><span style=display:flex><span>system_u:object_r:lib_t          lib64
</span></span><span style=display:flex><span>system_u:object_r:mnt_t          mnt
</span></span><span style=display:flex><span>system_u:object_r:unlabeled_t    overlay
</span></span><span style=display:flex><span>system_u:object_r:proc_t         proc
</span></span><span style=display:flex><span>system_u:object_r:root_t         rom
</span></span><span style=display:flex><span>root:object_r:user_home_dir_t    root
</span></span><span style=display:flex><span>system_u:object_r:bin_t          sbin
</span></span><span style=display:flex><span>system_u:object_r:sysfs_t        sys
</span></span><span style=display:flex><span>system_u:object_r:tmpfs_t        tmp
</span></span><span style=display:flex><span>system_u:object_r:usr_t          usr
</span></span><span style=display:flex><span>system_u:object_r:default_t      var
</span></span><span style=display:flex><span>system_u:object_r:default_t      www
</span></span></code></pre></div><p>Also processes will receive a label, however <code>procd</code> does not yet set contexts.
This involves some C programming and should be tackled in the near future. The
list below show that <code>dropbear</code>, <code>netifd</code> and <code>odhcpd</code> all share the same
context labels.</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>root@OpenWrt:/# ps -Z
</span></span><span style=display:flex><span>  PID CONTEXT                          STAT COMMAND
</span></span><span style=display:flex><span>    <span style=color:#40a070>1</span> system_u:system_r:init_t         S    /sbin/procd
</span></span><span style=display:flex><span>    <span style=color:#40a070>2</span> system_u:system_r:kernel_t       SW   <span style=color:#666>[</span>kthreadd<span style=color:#666>]</span>
</span></span><span style=display:flex><span>    <span style=color:#40a070>3</span> system_u:system_r:kernel_t       IW&lt;  <span style=color:#666>[</span>rcu_gp<span style=color:#666>]</span>
</span></span><span style=display:flex><span>    <span style=color:#40a070>4</span> system_u:system_r:kernel_t       IW&lt;  <span style=color:#666>[</span>rcu_par_gp<span style=color:#666>]</span>
</span></span><span style=display:flex><span>    <span style=color:#40a070>5</span> system_u:system_r:kernel_t       IW   <span style=color:#666>[</span>kworker/0:0-eve<span style=color:#666>]</span>
</span></span><span style=display:flex><span>    <span style=color:#40a070>6</span> system_u:system_r:kernel_t       IW&lt;  <span style=color:#666>[</span>kworker/0:0H-kb<span style=color:#666>]</span>
</span></span><span style=display:flex><span>    <span style=color:#40a070>7</span> system_u:system_r:kernel_t       IW   <span style=color:#666>[</span>kworker/u2:0-ev<span style=color:#666>]</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>  <span style=color:#40a070>985</span> system_u:system_r:init_t         S    /usr/sbin/dropbear -F -P /var/run/
</span></span><span style=display:flex><span> <span style=color:#40a070>1060</span> system_u:system_r:init_t         S    /sbin/netifd
</span></span><span style=display:flex><span> <span style=color:#40a070>1100</span> system_u:system_r:init_t         S    /usr/sbin/odhcpd
</span></span><span style=display:flex><span> <span style=color:#40a070>1327</span> system_u:system_r:init_t         S&lt;   /usr/sbin/ntpd -n -N -S /usr/sbin/
</span></span><span style=display:flex><span> <span style=color:#40a070>1712</span> system_u:system_r:init_t         R    ps -Z
</span></span></code></pre></div><p>This wraps up the current state. There is still more to do, a few points in the
next section.</p><h2 id=todo-updated-20200922>ToDo (Updated 2020/09/22)</h2><p>The fun didn&rsquo;t quite come to an end yet:</p><ul><li><del>A <a href=https://github.com/openwrt/packages/pull/10664>pending Pull Request</a> over at <code>openwrt/packages.git</code> will add additional
tools like <code>audit2allow</code>.</del> Merged</li><li>Extending <a href="https://git.openwrt.org/?p=project/procd.git"><code>procd</code></a> to set correct contexts</li><li><a href=https://github.com/openwrt/openwrt/pull/3448>Another Pull Request</a> to use <code>refpolicy</code> labels in <a href=https://github.com/openwrt/openwrt/blob/master/scripts/ipkg-build><code>ipkg-build</code></a>.</li><li>Offer ImageBuilders with a second Kernel supporting SELinux features.</li></ul></content><p></p></main><footer></footer></body></html>